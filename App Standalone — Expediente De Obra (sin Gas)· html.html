<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Expediente de Obra — App (Standalone)</title>

<style>

:root {
  --form-w: 600px;
  --regs-w: 1fr;
  --layout-gap: 18px;
  --brand1: #0d3b66;
  --brand2: #175fa6;
  --bg: #F3F6FB;
  --card: #fff;
  --borde: #e5e7eb;
  --text: #0f172a;
  --muted: #64748b;
  --red: #dc2626;
  --purple: #6D28D9;
  --blue: #2563eb;
  --amber: #f59e0b;
  --green: #10b981;
  --blue-600: #2563eb;
  --purple-600: #7c3aed;
  --purple-glow: rgba(124,58,237,.35);
  --purple-bg: rgba(124,58,237,.10);
}

* {
  box-sizing: border-box;
}

html, body {
  margin: 0;
  height: 100%;
}

body {
  font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}

.card {
  background: var(--card);
  border: 1px solid var(--borde);
  border-radius: 14px;
  box-shadow: 0 10px 25px rgba(0,0,0,.06);
}

header.appbar {
  background: linear-gradient(90deg, var(--brand1), var(--brand2));
  color: #fff;
  padding: 12px 16px;
}

header.appbar h1 {
  margin: 0;
  font-size: 18px;
}

main {
  width: 100%;
  max-width: none;
  margin: 14px 0;
  padding: 0 18px;
}

label {
  display: block;
  font-size: 12px;
  color: #334155;
  margin-bottom: 4px;
}

input, textarea, select {
  width: 100%;
  border: 1px solid var(--borde);
  border-radius: 12px;
  padding: 10px;
  background: #fff;
}

textarea {
  min-height: 72px;
}

.grid-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.grid-3 {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 14px;
}

.grid-4 {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 10px;
}

.inline {
  display: flex;
  gap: 8px;
  align-items: end;
}

.inline > *:first-child {
  flex: 1;
}

.actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
  flex-wrap: wrap;
}

button {
  border: 0;
  border-radius: 999px;
  padding: 10px 14px;
  cursor: pointer;
  background: var(--brand1);
  color: #fff;
}

button.ghost {
  background: #fff;
  color: #0d3b66;
  border: 1px solid var(--borde);
}

button.warn {
  background: var(--red);
}

.purple {
  background: var(--purple);
}

.blue {
  background: var(--blue);
}

.small-btn {
  border-radius: 10px;
  padding: 6px 10px;
}

.table {
  overflow: auto;
  border: 1px solid var(--borde);
  border-radius: 12px;
  background: #fff;
}

table {
  width: 100%;
  border-collapse: collapse;
}

thead th {
  position: sticky;
  top: 0;
  background: #f8fafc;
  border-bottom: 1px solid var(--borde);
  text-align: left;
  font-size: 12px;
  padding: 8px;
}

tbody td {
  border-bottom: 1px solid #f1f5f9;
  padding: 8px;
  font-size: 13px;
  vertical-align: top;
}

tbody tr.active {
  background: #eef2ff;
}

.oculto {
  display: none !important;
}

.hidden {
  display: none !important;
}

#login {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
}

.small-note {
  color: var(--muted);
  font-size: 12px;
  margin-top: 6px;
}

.badge {
  display: inline-block;
  padding: 2px 10px;
  border-radius: 999px;
  font-size: 12px;
  border: 1px solid transparent;
  font-weight: 600;
}

.badge-amber {
  color: #92400e;
  background: #FEF3C7;
  border-color: #FDE68A;
}

.badge-red {
  color: #7f1d1d;
  background: #FEE2E2;
  border-color: #FCA5A5;
}

.badge-blue {
  color: #1e3a8a;
  background: #DBEAFE;
  border-color: #93C5FD;
}

.badge-green {
  color: #064e3b;
  background: #D1FAE5;
  border-color: #A7F3D0;
}

#tabla [data-e],
#tabla [data-d],
#tabla [data-dev],
#tabla [data-aut],
#tabla [data-amp],
#tabla [data-mod],
#tabla [data-can] {
  border: 0;
  border-radius: 999px;
  padding: 8px 12px;
  color: #fff;
}

#tabla [data-e] {
  background: var(--purple);
}

#tabla [data-d] {
  background: var(--red);
}

#tabla [data-dev] {
  background: var(--red);
}

#tabla [data-aut] {
  background: var(--blue);
}

#tabla [data-amp] {
  background: #0ea5e9;
}

#tabla [data-mod] {
  background: #10b981;
}

#tabla [data-can] {
  background: #f97316;
}

#tabla table th:first-child,
#tabla table td:first-child {
  display: none;
}

.section-sub {
  display: none;
}

.section-sub.active {
  display: block;
}

.section-sub h3 {
  margin: 0;
  padding: 12px 14px;
  background: #f8fafc;
  border-bottom: 1px solid var(--borde);
  border-radius: 12px 12px 0 0;
  color: var(--brand1);
}

.section-sub .body {
  padding: 12px 14px;
}

dialog {
  border: 0;
  border-radius: 14px;
  max-width: 980px;
  width: clamp(320px, 90vw, 980px);
  padding: 0;
}

dialog::backdrop {
  background: rgba(0,0,0,.35);
}

.dialog-h {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--brand1);
  color: #fff;
  border-radius: 14px 14px 0 0;
  padding: 10px 16px;
}

.dialog-b {
  padding: 14px;
  max-height: 75vh;
  overflow: auto;
}

.dialog-f {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  border-top: 1px solid var(--borde);
  padding: 10px 14px;
}

.btn-cancel {
  background: #fff;
  color: #334155;
  border: 1px solid var(--borde);
}

.btn-primary {
  background: var(--blue);
}

#layout {
  display: grid;
  gap: var(--layout-gap);
  align-items: start;
  grid-template-columns: minmax(500px, var(--form-w)) minmax(0, var(--regs-w));
  grid-template-areas: "form regs";
}

#col-form {
  grid-area: form;
}

#col-regs {
  grid-area: regs;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

@media (max-width: 980px) {
  #layout {
    grid-template-columns: 1fr;
    grid-template-areas: "form" "regs";
  }
}

.mini {
  font-size: 12px;
  color: #334155;
}

#mainNav {
  display: flex;
  gap: 8px;
  align-items: center;
  margin: 10px 18px 0 18px;
}

#mainNav .nav-btn {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  background: #fff;
  cursor: pointer;
}

#mainNav .nav-btn.active {
  background: #0ea5e9;
  color: #fff;
  border-color: #0ea5e9;
}

.view {
  display: none;
  padding: 12px 18px;
}

.view.active {
  display: block;
}

.card-grid {
  display: grid;
  grid-template-columns: repeat(4, minmax(160px, 1fr));
  gap: 12px;
}

.kpi {
  padding: 14px;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  background: #fff;
}

.kpi .lbl {
  font-size: 12px;
  color: #64748b;
}

.kpi .val {
  font-size: 20px;
  font-weight: 700;
  margin-top: 6px;
}

.donut {
  display: flex;
  gap: 18px;
  align-items: center;
}

.donut svg {
  width: 220px;
  height: 220px;
}

.legend {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.pill {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 999px;
  background: #f3f4f6;
  font-size: 12px;
}

#dlgAutFicha {
  max-width: 1200px;
  width: clamp(500px, 96vw, 1200px);
}

#dlgAutFicha .two-col {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

#dlgAutFicha .muted {
  color: #64748b;
}

#dlgAutFicha .h6 {
  font-weight: 700;
  margin: 8px 0 4px;
}

.autorizaciones-layout {
  display: flex;
  gap: 16px;
}

.aut-sidebar {
  min-width: 220px;
  max-width: 260px;
}

.aut-main {
  flex: 1;
}

.chip {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  margin: 6px 0;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid #e5e7eb;
  background: #fff;
  cursor: pointer;
}

.chip.active {
  border-color: #3b82f6;
  background: #eff6ff;
}

.chip.sub {
  padding-left: 16px;
}

.chip.year .caret {
  display: inline-block;
  width: 0;
  height: 0;
  margin-right: 6px;
  border-left: 6px solid #374151;
  border-top: 4px solid transparent;
  border-bottom: 4px solid transparent;
  transform: rotate(0deg);
  transition: .18s;
}

.chip.year.open .caret {
  transform: rotate(90deg);
}

.aut-sidebar .chip.year {
  color: #2563eb;
  border-color: #bfdbfe;
}

.aut-sidebar .chip.year.active {
  background: #eff6ff;
  border-color: #60a5fa;
  color: #1d4ed8;
}

.aut-sidebar .chip.sub {
  color: #7c3aed;
  border-color: #e9d5ff;
}

.aut-sidebar .chip.sub.active {
  background: #faf5ff;
  border-color: #a78bfa;
  color: #6d28d9;
}

.aut-sidebar .chip .pill.money {
  color: #111 !important;
  background: #f3f4f6;
  border-color: #e5e7eb;
}

.aut-sidebar .chip.year .caret {
  border-left-color: currentColor;
}

.aut-sidebar .chip.year:hover {
  color: #1d4ed8;
}

.aut-sidebar .chip.sub:hover {
  color: #6d28d9;
}

#aut_conc_container .grid-4 > div label {
  display: block;
  font-size: 12px;
  color: #6b7280;
  margin-bottom: 4px;
}

#aut_conc_container .grid-4 > div input {
  width: 100%;
}

#aut_conc_container {
  border-top: 1px dashed #e5e7eb;
  margin: 10px 0 0 0;
  padding-top: 10px;
}

.table {
  overflow: visible;
}

.table table {
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  background: #fff;
  transition: box-shadow .18s ease, border-color .18s ease;
  box-shadow: 0 0 0 0 rgba(96,165,250,0);
}

.table table:hover {
  border-color: #93c5fd;
  box-shadow: 0 0 0 2px rgba(96,165,250,.35), 0 0 18px 2px rgba(96,165,250,.22);
}

.table table:focus-within {
  border-color: #93c5fd;
  box-shadow: 0 0 0 2px rgba(96,165,250,.35), 0 0 18px 2px rgba(96,165,250,.22);
}

@media (prefers-reduced-motion: reduce) {
  .table table {
    transition: none;
  }
}

#mainNav .nav-btn,
.btn-glow {
  color: var(--blue-600);
  background: transparent;
  border: 1px solid rgba(37,99,235,.18);
  border-radius: 9999px;
  padding: 6px 14px;
  font-weight: 600;
  transition: box-shadow .18s ease, background-color .18s ease, color .18s ease, transform .06s ease;
}

#mainNav .nav-btn:hover,
#mainNav .nav-btn:focus-visible,
.btn-glow:hover,
.btn-glow:focus-visible {
  background: var(--purple-bg);
  box-shadow: 0 8px 22px var(--purple-glow), 0 0 0 6px rgba(124,58,237,.18);
  outline: none;
}

#mainNav .nav-btn.active,
.btn-glow.active,
.btn-glow[aria-current="page"] {
  background: var(--purple-bg);
  box-shadow: 0 10px 30px var(--purple-glow), 0 0 0 6px rgba(124,58,237,.22);
}

#mainNav .nav-btn:active,
.btn-glow:active {
  transform: translateY(1px) scale(.985);
}

.w-full {
  width: 100%;
}

.w-120 {
  width: 120px;
}

.right {
  text-align: right;
}

.act-set {
  display: none;
}

.group-row {
  background-color: #f8fafc;
}

.sub {
  background-color: #f1f5f9;
}

.ej-row.hidden {
  display: none;
}

.row-actions {
  white-space: nowrap;
}

.conc-item {
  margin-bottom: 10px;
  padding: 10px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  background: #fafafa;
}

/* Aplícalo en tu CSS global */
.table td:last-child{ position:relative; overflow:visible !important; }

.act-set{
  position:absolute;
  top:100%;        /* debajo del botón */
  right:8px;
  min-width:220px;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:10px;
  box-shadow:0 8px 20px rgba(0,0,0,.12);
  padding:8px;
  display:none;    /* el JS la pone en block */
  z-index:9999;
}
.act-set .small-btn{
  display:block;
  width:100%;
  text-align:left;
  margin:4px 0;
}

</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
  <div class="card" style="max-width:360px;width:100%">
    <header><h1>Entrar</h1></header>
    <div style="padding:14px">
      <label>Usuario</label><input id="u" value="admin" autofocus/>
      <label>Contraseña</label><input id="p" type="password" value="1234"/>
      <div class="actions"><button id="loginBtn" type="button">Entrar</button></div>
      <p class="small-note">Demo: admin/1234</p>
    </div>
  </div>
</div>

<!-- APP -->
<section id="app" class="oculto">
  <header class="appbar"><h1>Expediente de Obra — App (Standalone)</h1></header>

  <!-- NAV -->
  <nav id="mainNav">
    <button class="nav-btn" data-view="home" type="button">Inicio</button>
    <button class="nav-btn" data-view="gestionar" type="button">Gestionar</button>
    <button class="nav-btn" data-view="autorizaciones" type="button">Autorizaciones</button>
    <button class="nav-btn" data-view="directorio" type="button">Directorio</button>
    <button class="nav-btn" data-view="fondos" type="button">Fondos</button>
  </nav>

  <main>
    <!-- ====== INICIO / DASHBOARD ====== -->
    <section id="view-home" class="view active">
      <div class="card" style="padding:14px">
        <h2 style="margin:6px 0 12px 0;color:#0d3b66">Resumen</h2>
        <div class="donut">
          <div id="donutWrap"></div>
          <div><div class="legend" id="donutLegend"></div></div>
        </div>
      </div>

      <div class="card-grid" style="margin-top:12px">
        <div class="kpi"><div class="lbl">Total Expedientes</div><div class="val" id="kpiTotal">—</div></div>
        <div class="kpi"><div class="lbl">Autorizaciones (registros)</div><div class="val" id="kpiAutos">—</div></div>
        <div class="kpi"><div class="lbl">Monto Autorizado</div><div class="val" id="kpiAutMonto">—</div></div>
        <div class="kpi"><div class="lbl">Última actualización</div><div class="val" id="kpiUpd">—</div></div>
      </div>

      <div class="grid-2" style="margin-top:12px">
        <div class="card" style="padding:14px">
          <h3 style="margin:0 0 8px 0;color:#0d3b66">Autorizado por Dependencia</h3>
          <div class="table" id="tblByDep"></div>
        </div>
        <div class="card" style="padding:14px">
          <h3 style="margin:0 0 8px 0;color:#0d3b66">Autorizado por Fondo</h3>
          <div class="table" id="tblByFondo"></div>
        </div>
      </div>
    </section>

    <!-- ====== GESTIONAR ====== -->
    <section id="view-gestionar" class="view">
      <div id="layout">
        <!-- FORM -->
        <section id="col-form" class="card" style="padding:14px">
          <h2 style="margin:6px 0 12px 0;font-size:16px;color:#0d3b66">Formulario</h2>
          <form id="f">
            <input type="hidden" id="id"/>
            <input type="hidden" id="estatus"/>

            <div class="grid-3">
              <div><label>Ejercicio</label><input id="ejercicio" type="number"/></div>
              <div><label>Fecha Recepción</label><input id="fecha_recepcion" type="date"/></div>
              <div><label>Fecha Elaboración</label><input id="fecha_elaboracion" type="date"/></div>
            </div>

            <div class="grid-3">
              <div>
                <label>Dependencia</label>
                <div class="inline">
                  <select id="dependencia"></select>
                  <button id="btnAddDep" type="button" class="ghost small-btn">➕</button>
                </div>
              </div>
              <div><label>Ejecutora</label><input id="ejecutora"/></div>
            </div>

            <fieldset>
              <legend>Datos de la Obra</legend>
              <div class="grid-4">
                <div><label>No. Oficio</label><input id="no_oficio"/></div>
                <div>
                  <label>Tipo de Documento</label>
                  <select id="tipo_documento">
                    <option value="" disabled selected>Selecciona…</option>
                    <option value="AUTORIZACIÓN">AUTORIZACIÓN</option>
                    <option value="AMPLIACIÓN">AMPLIACIÓN</option>
                    <option value="CANCELACIÓN">CANCELACIÓN</option>
                    <option value="MODIFICACIÓN">MODIFICACIÓN</option>
                  </select>
                </div>
                <div><label>No. Contrato</label><input id="no_contrato"/></div>
                <div>
                  <label>No. de Expediente</label>
                  <input id="no_expediente_edit" placeholder="2025OP000001"/>
                  <div class="mini" id="exp_preview" style="margin-top:4px;color:#0d3b66;font-weight:700">—</div>
                  <input id="no_expediente" type="hidden"/>
                </div>
                <div style="grid-column:1 / -1"><label>Nombre de la Obra / Proyecto</label><textarea id="nombre_obra"></textarea></div>
              </div>
            </fieldset>

            <fieldset>
              <legend>Financiamiento <span id="totalChip" style="margin-left:8px;font-weight:700;color:#0d3b66">$0.00</span></legend>
              <div class="grid-3">
                <div>
                  <label>Fondo</label>
                  <div class="inline">
                    <select id="fondo"></select>
                    <button id="btnAddFondo" type="button" class="ghost small-btn">➕</button>
                  </div>
                </div>
                <div><label>Importe (base)</label><input id="importe" type="text" inputmode="decimal"/></div>
              </div>
              <div id="concWrap" style="margin-top:8px"></div>
              <div class="actions"><button id="addConc" type="button" class="ghost">➕ Agregar concurrencia</button></div>
            </fieldset>

            <fieldset>
              <legend>Área responsable</legend>
              <div class="grid-3">
                <div><label>Departamento</label><input id="departamento"/></div>
                <div><label>Responsable del Trámite</label><input id="responsable_tramite"/></div>
              </div>
            </fieldset>

            <div class="actions">
              <button id="save" type="button">💾 Guardar</button>
              <button id="btnew" type="button" class="ghost">➕ Nuevo</button>
              <button id="clear" type="button" class="ghost">🧹 Limpiar</button>
            </div>
            <div class="small-note">* Al guardar: Estatus ⇒ <b>EN TRÁMITE</b> (amarillo) salvo que agregues Devolución o Autorización.</div>
          </form>
        </section>

        <!-- REGISTROS + PANELES -->
        <section id="col-regs">
          <div class="card" style="padding:14px">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
              <h2 style="margin:6px 0 12px 0;font-size:16px;color:#0d3b66">Registros</h2>
              <div class="toolbar" style="display:flex;gap:8px;align-items:center">
                <input type="search" id="q" placeholder="Buscar por texto…" />
                <button id="search" type="button" class="ghost">Buscar</button>
                <button id="refresh" type="button" class="ghost">Actualizar</button>
              </div>
            </div>

            <div class="table" id="tabla"></div>

            <div id="regsEmpty" style="display:none;padding:10px 0;color:#6b7280">
              No hay registros para mostrar.
            </div>
          </div>

          <div class="card section-sub" id="panelAut">
            <h3>Autorizaciones del registro</h3>
            <div class="body" id="listAut"></div>
          </div>

          <div class="card section-sub" id="panelAmp">
            <h3>Ampliaciones del registro</h3>
            <div class="body" id="listAmp"></div>
          </div>

          <div class="card section-sub" id="panelMod">
            <h3>Modificaciones del registro</h3>
            <div class="body" id="listMod"></div>
          </div>

          <div class="card section-sub" id="panelCan">
            <h3>Cancelaciones del registro</h3>
            <div class="body" id="listCan"></div>
          </div>

          <div class="card section-sub" id="panelDev">
            <h3>Devoluciones del registro</h3>
            <div class="body" id="listDev"></div>
          </div>
        </section>
      </div>
    </section>

    <!-- ====== AUTORIZACIONES (VISTA) ====== -->
    <section id="view-autorizaciones" class="view">
      <div class="card" style="padding:14px">
        <h2 style="margin:6px 0 12px 0;color:#0d3b66">Autorizaciones</h2>

        <div class="autorizaciones-layout">
          <!-- Sidebar con años/fondos -->
          <aside id="autSidebar" class="aut-sidebar"></aside>

          <!-- Main con toolbar y tabla -->
          <div class="aut-main">
            <div class="toolbar">
              <input id="autListQ" type="search" placeholder="Buscar texto..."/>
              <button id="autListRefresh" class="ghost" type="button">Actualizar</button>
            </div>

            <div id="autListTable"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ====== DIRECTORIO ====== -->
    <section id="view-directorio" class="view">
      <div class="card" style="padding:14px">
        <h2 style="margin:6px 0 12px 0;color:#0d3b66">Directorio de Dependencias</h2>
        <div class="grid-3">
          <div><label>Dependencia</label><input id="dir_dep"/></div>
          <div><label>Director(a)</label><input id="dir_dir"/></div>
          <div><label>Cargo</label><input id="dir_cargo"/></div>
        </div>
        <div class="actions">
          <button id="dirAdd" type="button">Guardar</button>
          <button id="dirClear" type="button" class="ghost">Limpiar</button>
        </div>
        <div id="dirTable" class="table" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- ======= VISTA: Fondos ======= -->
    <section id="view-fondos" class="view">
      <div class="card">
        <div class="card-h"><strong>Fondos</strong></div>
        <div class="card-b">
          <div class="grid-2">
            <div>
              <h4 style="margin:0 0 6px">Códigos</h4>
              <div id="fondosTable"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ==== DIALOGS ==== -->
  <!-- DEVOLUCIÓN -->
  <dialog id="dlgDev">
    <div class="dialog-h">
      <strong>Devolución del Registro</strong>
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlgDev').close()">Cerrar</button>
    </div>
    <div class="dialog-b">
      <form id="formDev">
        <input type="hidden" data-f="id_dp"/>
        <div class="grid-3">
          <div><label>Fecha de Elaboración</label><input type="date" data-f="fecha_elab"/></div>
          <div><label>No. de Oficio</label><input data-f="no_oficio"/></div>
          <div><label>No. de Expediente</label><input data-f="no_expediente" readonly/></div>
        </div>
        <div class="grid-3">
          <div><label>Tipo de Documento</label><input data-f="tipo_documento" readonly/></div>
          <div><label>Importe</label><input type="text" inputmode="decimal" data-f="importe"/></div>
          <div><label>Estatus</label><input value="DEVOLUCIÓN" readonly/></div>
        </div>
        <div><label>Descripción</label><textarea data-f="descripcion"></textarea></div>
        <div><label>Motivo</label><textarea data-f="motivo"></textarea></div>
      </form>
    </div>
    <div class="dialog-f">
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlgDev').close()">Cancelar</button>
      <button type="button" id="btnDevSave" class="warn">Guardar Devolución</button>
    </div>
  </dialog>

  <!-- AUTORIZACIÓN -->
  <dialog id="dlgAut">
    <div class="dialog-h">
      <strong>Oficio de Autorización</strong>
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlgAut').close()">Cerrar</button>
    </div>
    <div class="dialog-b">
      <form id="formAut">
        <input id="aut_id_unico" type="hidden" data-f="id_unico"/>

        <div class="grid-4">
          <div><label>ID Proyecto</label><input id="aut_id_proy" data-f="id_proyecto" readonly/></div>
          <div><label>Ejercicio</label><input id="aut_ejercicio" data-f="ejercicio" readonly/></div>
          <div><label>Oficio de Autorización</label><input list="dl_aut_oficios" data-f="oficio_aut"/></div>
          <datalist id="dl_aut_oficios"></datalist>
          <div><label>Fondo</label><select id="aut_fondo" data-f="fondo"></select></div>
          <div id="grp_sifais"><label>Folio SIFAIS</label><input id="aut_folio_sifais" data-f="folio_sifais"/></div>
          <div><label>¿Oficio Estatal?</label><select id="aut_es_estatal" data-f="es_estatal"><option>No</option><option>Sí</option></select></div>
          <div id="grp_aut_estatal" class="hidden"><label>Oficio Aut. Estatal</label><input id="aut_oficio_estatal" data-f="oficio_aut_estatal" value="N/A"/></div>
          <div id="grp_fecha_aut" class="hidden"><label>Fecha Autorización</label><input type="date" id="aut_fecha_aut" data-f="fecha_aut"/></div>
          <div style="grid-column:1 / -1"><label>Dirección</label><input id="aut_direccion" data-f="direccion" readonly/></div>
          <div style="grid-column:1 / -1"><label>Nombre de la Obra</label><input id="aut_nombre_obra" data-f="nombre_obra" readonly/></div>
          <div><label>Autorizado</label><input id="aut_autorizado" data-f="autorizado_mod"/></div>
          <div><label>Inversión Modificada</label><input data-f="inversion_modificada"/></div>
          <div><label>CTA Contable</label><input data-f="cta_contable"/></div>
          <div><label>COG</label><input data-f="cog"/></div>
        </div>

        <!-- Concurrencias (Autorización) -->
        <div id="aut_conc_container" class="hidden">
          <!-- GRUPO 1 -->
          <div class="conc-group grid-4" data-conc="1" style="display:none">
            <div>
              <label for="oficio_aut_1">Oficio autorización 1</label>
              <input id="oficio_aut_1" data-f="oficio_aut_1" placeholder="p.ej. OA-123/2025"/>
            </div>

            <div>
              <label for="fondo_conc_1">Fondo concurrencia 1</label>
              <div class="inline">
                <select id="fondo_conc_1" data-f="fondo_conc_1"></select>
                <button type="button" class="ghost small-btn" data-add-fondo-target="fondo_conc_1">➕</button>
              </div>
            </div>

            <div>
              <label for="imp_conc_1">Autorizado concurrencia 1</label>
              <input id="imp_conc_1" data-f="imp_conc_1" inputmode="decimal" placeholder="$0.00"/>
            </div>

            <div>
              <label for="imp_conc_1_mod">Inversión modificada concurrencia 1</label>
              <input id="imp_conc_1_mod" data-f="imp_conc_1_mod" inputmode="decimal" placeholder="$0.00"/>
            </div>

            <div>
              <label for="cta_cont_1">CTA contable concurrencia 1</label>
              <input id="cta_cont_1" data-f="cta_cont_1" placeholder="XXX-XXX-XXX"/>
            </div>

            <div>
              <label for="cog_1">COG concurrencia 1</label>
              <input id="cog_1" data-f="cog_1" placeholder="XXXXXX"/>
            </div>
          </div>

          <!-- GRUPO 2 -->
          <div class="conc-group grid-4" data-conc="2" style="display:none">
            <div>
              <label for="oficio_aut_2">Oficio autorización 2</label>
              <input id="oficio_aut_2" data-f="oficio_aut_2" placeholder="p.ej. OA-456/2025"/>
            </div>

            <div>
              <label for="fondo_conc_2">Fondo concurrencia 2</label>
              <div class="inline">
                <select id="fondo_conc_2" data-f="fondo_conc_2"></select>
                <button type="button" class="ghost small-btn" data-add-fondo-target="fondo_conc_2">➕</button>
              </div>
            </div>

            <div>
              <label for="imp_conc_2">Autorizado concurrencia 2</label>
              <input id="imp_conc_2" data-f="imp_conc_2" inputmode="decimal" placeholder="$0.00"/>
            </div>

            <div>
              <label for="imp_conc_2_mod">Inversión modificada concurrencia 2</label>
              <input id="imp_conc_2_mod" data-f="imp_conc_2_mod" inputmode="decimal" placeholder="$0.00"/>
            </div>

            <div>
              <label for="cta_cont_2">CTA contable concurrencia 2</label>
              <input id="cta_cont_2" data-f="cta_cont_2" placeholder="XXX-XXX-XXX"/>
            </div>

            <div>
              <label for="cog_2">COG concurrencia 2</label>
              <input id="cog_2" data-f="cog_2" placeholder="XXXXXX"/>
            </div>
          </div>
        </div>

        <div class="grid-4">
          <div><label>PBR</label><input data-f="pbr"/></div>
          <div><label>Línea de Acción</label><input data-f="linea_accion"/></div>
          <div><label>U.M</label><input data-f="um"/></div>
          <div><label>Metas</label><input data-f="metas"/></div>
          <div><label>Tipo de Beneficiario</label><input data-f="tipo_beneficiario"/></div>
          <div><label>No. de Beneficiario</label><input data-f="no_beneficiario"/></div>
          <div><label>Fecha de Creación</label><input type="date" data-f="fecha_creacion"/></div>
          <div><label>Fecha de Inicio</label><input type="date" data-f="fecha_inicio"/></div>
          <div><label>Fecha Final</label><input type="date" data-f="fecha_final"/></div>
        </div>
      </form>
    </div>
    <div class="dialog-f">
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlgAut').close()">Cancelar</button>
      <button type="button" id="btnAutSave" class="btn-primary">Guardar Autorización</button>
    </div>
  </dialog>

  <!-- AMPLIACIÓN -->
  <dialog id="dlgAmp">
    <div class="dialog-h">
      <strong>Oficio de Ampliación</strong>
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlgAmp').close()">Cerrar</button>
    </div>
    <div class="dialog-b">
      <form id="formAmp">
        <input id="amp_id_ampliacion" type="hidden" data-f="id_ampliacion"/>
        <div class="grid-4">
          <div><label>ID Proyecto</label><input data-f="id_proyecto" readonly/></div>
          <div><label>Dirección</label><input id="amp_direccion" data-f="direccion" readonly/></div>
          <div><label>Fondo</label><select id="amp_fondo" data-f="fondo"></select></div>
          <div><label>Nombre de la Obra</label><input data-f="nombre_obra" readonly/></div>
          <div><label>Oficio de Ampliación</label><input data-f="oficio_ampliacion"/></div>
          <div><label>Inversión Modificada</label><input data-f="inversion_modificada"/></div>
          <div><label>Ampliación Autorizada</label><input data-f="ampliacion_autorizada"/></div>
          <div><label>Ampliación Concertado 1</label><input data-f="ampliacion_concertado_1"/></div>
          <div><label>Ampliación Concertado 2</label><input data-f="ampliacion_concertado_2"/></div>
          <div><label>Fecha de Autorizado</label><input type="date" data-f="fecha_autorizado"/></div>
          <div><label>Motivo de la Ampliación</label><input data-f="motivo_ampliacion"/></div>
        </div>
      </form>
    </div>
    <div class="dialog-f">
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlgAmp').close()">Cancelar</button>
      <button type="button" id="btnAmpSave" class="btn-primary">Guardar Ampliación</button>
    </div>
  </dialog>

  <!-- MODIFICACIÓN -->
  <dialog id="dlgMod">
    <div class="dialog-h">
      <strong>Oficio de Modificación</strong>
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlgMod').close()">Cerrar</button>
    </div>
    <div class="dialog-b">
      <form id="formMod">
        <input id="mod_id_modificacion" type="hidden" data-f="id_modificacion"/>
        <div class="grid-4">
          <div><label>ID Proyecto</label><input data-f="id_proyecto" readonly/></div>
          <div><label>Dirección</label><input id="mod_direccion" data-f="direccion" readonly/></div>
          <div><label>Fondo</label><select id="mod_fondo" data-f="fondo"></select></div>
          <div><label>Nombre de la Obra</label><input data-f="nombre_obra" readonly/></div>
          <div><label>Oficio de Modificación</label><input data-f="oficio_modificacion"/></div>
          <div><label>Inversión Modificada</label><input data-f="inversion_modificada"/></div>
          <div><label>Modificación Autorizada</label><input data-f="modificacion_autorizada"/></div>
          <div><label>Modificación Concertado 1</label><input data-f="modificacion_concertado_1"/></div>
          <div><label>Modificación Concertado 2</label><input data-f="modificacion_concertado_2"/></div>
          <div><label>Motivo de la Modificación</label><input data-f="motivo_modificacion"/></div>
          <div><label>Fecha de Autorizado</label><input type="date" data-f="fecha_autorizado"/></div>
        </div>
      </form>
    </div>
    <div class="dialog-f">
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlgMod').close()">Cancelar</button>
      <button type="button" id="btnModSave" class="btn-primary">Guardar Modificación</button>
    </div>
  </dialog>

  <!-- CANCELACIÓN -->
  <dialog id="dlgCan">
    <div class="dialog-h">
      <strong>Oficio de Cancelación</strong>
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlgCan').close()">Cerrar</button>
    </div>

    <div class="dialog-b">
      <form id="formCan">
        <input id="can_id_cancelacion" type="hidden" data-f="id_cancelacion"/>
        <div class="grid-4">
          <div><label>ID Proyecto</label><input data-f="id_proyecto" readonly/></div>
          <div><label>Dirección</label><input id="can_direccion" data-f="direccion" readonly/></div>
          <div><label>Fondo</label><select id="can_fondo" data-f="fondo"></select></div>
          <div><label>Nombre de la Obra</label><input data-f="nombre_obra" readonly/></div>

          <div><label>Oficio de Cancelación</label><input data-f="oficio_cancelacion"/></div>
          <div><label>Cancelación Autorizada</label><input data-f="cancelacion_autorizada"/></div>
          <div><label>Cancelación Concertado 1</label><input data-f="cancelacion_concertado_1"/></div>
          <div><label>Cancelación Concertado 2</label><input data-f="cancelacion_concertado_2"/></div>

          <div><label>Fecha de Autorizado</label><input type="date" data-f="fecha_autorizado"/></div>
          <div><label>Motivo de la Cancelación</label><input data-f="motivo_cancelacion"/></div>
        </div>
      </form>
    </div>

    <div class="dialog-f">
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlgCan').close()">Cancelar</button>
      <button type="button" id="btnCanSave" class="btn-primary">Guardar Cancelación</button>
    </div>
  </dialog>

  <!-- FICHA AUTORIZACIÓN -->
  <dialog id="dlgAutFicha">
    <div class="dialog-h">
      <strong>Ficha de Autorización</strong>
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlgAutFicha').close()">Cerrar</button>
    </div>
    <div class="dialog-b" id="autFichaBody"></div>
    <div class="dialog-f">
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlgAutFicha').close()">Cerrar</button>
    </div>
  </dialog>
</section>

<script>
// Define the function BEFORE any code that uses it
function renderDetails(data) {
  const container = document.getElementById('app');
  if (container && data) {
    container.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
  }
}

// ======= Estado global
let isNewRecord = true;
let selectedId = null;
let fondosEditCode = null;
let _savingMain = false;
let dirEditIdx = -1;

// ======= Constantes
const DB = 'app_exp_obra';
const VER = 7;
let db = null;

// ======= Keys de localStorage
const DEPS_KEY = 'deps_list_v1';
const DIR_KEY = 'deps_dir_v1';
const FONDOS_KEY = 'fondos_list_v1';
const FONDOS_META_KEY = 'fondos_meta_v1';
const FONDOS_TECHOS_KEY = 'fondos_techos_v1';
const EXP_SEQ_KEY = 'exp_seq_map_v1';
const AUT_SIDEBAR_STATE_KEY = 'aut_years_collapsed_v1';

// ======= Datos semilla
const DEPS_SEED = [
  "Despacho del Presidente Municipal","Coordinación de Comunicación Social",
  "Coordinación de Relaciones Públicas","Coordinación de Transparencia, Gobierno Abierto y Archivos",
  "Dirección de Desarrollo Económico y Competitividad","Dirección de Desarrollo Humano y Educación",
  "Dirección de Desarrollo Rural","Dirección de Desarrollo Urbano y Ecología",
  "Dirección de Mantenimiento Urbano","Dirección de Obras Públicas",
  "Dirección de Planeación e Innovación Gubernamental","Dirección de Seguridad Pública Municipal",
  "Dirección de Servicios Públicos Municipales","Oficialía Mayor",
  "Órgano Interno de Control","Regidores","Secretaría del H. Ayuntamiento",
  "Sindicatura","Tesorería Municipal","Consejo de Urbanización Municipal",
  "DIF Municipal","Instituto de Cultura del Municipio de Chihuahua",
  "Instituto de Planeación Integral del Municipio de Chihuahua",
  "Instituto Municipal de Cultura Física y Deporte","Instituto Municipal de las Mujeres",
  "Instituto Municipal de Pensiones","Instituto Municipal de Prevención y Atención a la Salud"
];

const FONDOS_SEED = [
  "FAISMUN/25","FAISMUN/26","FAISMUN/27","Recursos Propios",
  "Participaciones","FISM","FODES","Convenio Estatal",
  "Convenio Federal","DIRECTO/24","FODESM/24"
];

const DEP_CODE_MAP = [
  { match:'OBRAS PÚBLICAS', code:'OP' },
  { match:'OBRAS PUBLICAS', code:'OP' }
];

// ======= Utilidades DOM
function $(selector){ return document.querySelector(selector); }

function getFormValues(formSel){
  const obj = {};
  document.querySelectorAll(`${formSel} [data-f]`).forEach(el=>{
    const k = el.getAttribute('data-f');
    obj[k] = el.value ?? '';
  });
  return obj;
}
function setFormValues(formSel, data){
  document.querySelectorAll(`${formSel} [data-f]`).forEach(el=>{
    const k = el.getAttribute('data-f');
    el.value = (data && data[k] != null) ? data[k] : '';
  });
}
function fillSelect(sel, list, withEmpty=true){
  if(!sel) return;
  sel.innerHTML = (withEmpty?`<option value="">—</option>`:'') + (list||[]).map(v=>`<option>${v}</option>`).join('');
}
function fillSelectPreserve(sel, options){
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = options.map(v=>`<option value="${v}">${v}</option>`).join('');
  if (cur && [...sel.options].some(o=>o.value===cur)) sel.value = cur;
}

// ======= Utilidades generales
function toast(message){
  const d = document.createElement('div');
  d.className='card';
  d.style.cssText='position:fixed;right:16px;bottom:16px;padding:10px 12px;z-index:9999';
  d.textContent=message;
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),1600);
}
function uid(){ return 'OB-'+Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,6).toUpperCase(); }
function buildT(o){ return Object.values(o).map(v=>String(v??'').toLowerCase()).join('|'); }
function norm(s){ return String(s??'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().trim(); }
function autoYear(){ const el=$('#ejercicio'); if(el && !el.value){ el.value=new Date().getFullYear(); } }
function fmtMoney(v){ const n=Number(v||0); return n?n.toLocaleString('es-MX',{style:'currency',currency:'MXN'}):''; }
function fmt2(n){ return Number(n||0).toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2}); }
const moneyRE=/[^0-9.]/g;
function parseMoney(s){ return Number(String(s||'').replace(moneyRE,'')||0); }
function formatMoneyInput(el){ el.value = fmt2(parseMoney(el.value)); }

// ======= Fecha y letras
function fechaUpperMx(dstr){
  const d = dstr? new Date(dstr) : new Date();
  const meses=['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
  return `CHIHUAHUA, CHIH. A ${String(d.getDate())} DE ${meses[d.getMonth()]} DE ${d.getFullYear()}`;
}
function montoALetrasMX(n){
  n = Math.round((Number(n)||0)*100)/100;
  const enteros=Math.floor(n), cent=Math.round((n-enteros)*100);
  const U=['','UNO','DOS','TRES','CUATRO','CINCO','SEIS','SIETE','OCHO','NUEVE'];
  const D10=['DIEZ','ONCE','DOCE','TRECE','CATORCE','QUINCE','DIECISÉIS','DIECISIETE','DIECIOCHO','DIECINUEVE'];
  const D=['','DIEZ','VEINTE','TREINTA','CUARENTA','CINCUENTA','SESENTA','SETENTA','OCHENTA','NOVENTA'];
  const C=['','CIENTO','DOSCIENTOS','TRESCIENTOS','CUATROCIENTOS','QUINIENTOS','SEISCIENTOS','SETECIENTOS','OCHOCIENTOS'];
  const nn=n=>n<10?U[n]:n<20?D10[n-10]:n<30?('VEINTI'+U[n-20]).replace('VEINTIUNO','VEINTIÚN'):D[Math.floor(n/10)]+(n%10?(' Y '+U[n%10]):'');
  const nnn=n=>n===100?'CIEN':C[Math.floor(n/100)]+(n%100?(' '+nn(n%100)):'');
  let e=enteros, txt='';
  const millones=Math.floor(e/1_000_000); e%=1_000_000;
  const miles=Math.floor(e/1_000); e%=1_000;
  const cientos=e;
  if(millones) txt+=(millones===1?'UN MILLÓN':`${nnn(millones)} MILLONES`);
  if(miles) txt+=(txt?' ':'')+(miles===1?'MIL':`${nnn(miles)} MIL`);
  if(cientos) txt+=(txt?' ':'')+nnn(cientos);
  if(!txt) txt='CERO';
  const cc=String(cent).padStart(2,'0');
  return `${txt} PESOS ${cc}/100 M.N.`;
}

// ======= Catálogos
function seedCatalogs(){
  if(!localStorage.getItem(DEPS_KEY)) localStorage.setItem(DEPS_KEY, JSON.stringify(DEPS_SEED));
  if(!localStorage.getItem(FONDOS_KEY)) localStorage.setItem(FONDOS_KEY, JSON.stringify(FONDOS_SEED));
  if(!localStorage.getItem(FONDOS_META_KEY)){
    const codes = JSON.parse(localStorage.getItem(FONDOS_KEY)||'[]');
    const meta = codes.map(c=>({code:c, full_name:c}));
    localStorage.setItem(FONDOS_META_KEY, JSON.stringify(meta));
  }
  if(!localStorage.getItem(DIR_KEY)) localStorage.setItem(DIR_KEY,'[]');

  updateDependencyOptions();
  const fondos = JSON.parse(localStorage.getItem(FONDOS_KEY)||'[]');
  fillSelect($('#fondo'), fondos);
}
function depsFromDirectory(){
  const dir = JSON.parse(localStorage.getItem(DIR_KEY)||'[]');
  return [...new Set(dir.map(x=>x.dep).filter(Boolean))];
}
function updateDependencyOptions(){
  const fromDir = depsFromDirectory();
  const fallback = JSON.parse(localStorage.getItem(DEPS_KEY)||'[]');
  const list = fromDir.length ? fromDir : fallback;
  fillSelect($('#dependencia'), list);
}
function readFondosMeta(){
  const list = JSON.parse(localStorage.getItem(FONDOS_KEY)||'[]');
  const meta = JSON.parse(localStorage.getItem(FONDOS_META_KEY)||'[]');
  const byCode = Object.fromEntries(meta.map(m=>[m.code,m]));
  list.forEach(c=>{ if(!byCode[c]) byCode[c]={code:c, full_name:c}; });
  const merged = Object.values(byCode).filter(m=>m.code);
  localStorage.setItem(FONDOS_META_KEY, JSON.stringify(merged));
  localStorage.setItem(FONDOS_KEY, JSON.stringify(merged.map(m=>m.code)));
  return merged.sort((a,b)=>a.code.localeCompare(b.code));
}
function writeFondosMeta(merged){
  const clean = merged.filter(m=>m && m.code);
  localStorage.setItem(FONDOS_META_KEY, JSON.stringify(clean));
  localStorage.setItem(FONDOS_KEY, JSON.stringify(clean.map(m=>m.code)));
  refreshFondosCatalogFromMeta();
}
function refreshFondosCatalogFromMeta() {
  const meta = JSON.parse(localStorage.getItem(FONDOS_META_KEY) || '[]');
  const codes = meta.map(m => m.code).filter(Boolean).sort();
  localStorage.setItem(FONDOS_KEY, JSON.stringify(codes));

  // Seletores por id + por data-f (para los campos de concurrencia del diálogo)
  const selectorQueries = [
    '#fondo', '#autListFondo',
    '#aut_fondo', '#amp_fondo', '#mod_fondo', '#can_fondo',
    '[data-f="fondo_conc_1"]', '[data-f="fondo_conc_2"]'
  ];

  const seen = new Set();
  selectorQueries.forEach(q => {
    document.querySelectorAll(q).forEach(el => {
      if (seen.has(el)) return;
      seen.add(el);

      const cur = el.value; // preserva valor actual si existe

      if (el.id === 'autListFondo') {
        fillSelectPreserve(el, ['(Todos)', ...codes]);
      } else {
        fillSelectPreserve(el, codes);
      }

      // Si el valor previo existe en el catálogo, recupéralo
      if (cur && [...el.options].some(o => o.value === cur)) {
        el.value = cur;
      }
    });
  });
}

// ======= Vistas
function ensureMainMenu(){
  const nav = $('#mainNav');
  if(!nav) return;
  nav.addEventListener('click',(e)=>{
    const btn = e.target.closest('.nav-btn'); if(!btn) return;
    const view = btn.dataset.view; if(view) switchView(view);
  });
  switchView('home');
}
function switchView(name){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  const el=document.getElementById(`view-${name}`); if(el) el.classList.add('active');
  document.querySelectorAll('#mainNav .nav-btn').forEach(b=>b.classList.toggle('active', b.dataset.view===name));
  if(name==='home') renderDashboard();
  if(name==='autorizaciones') renderAutList();
  if(name==='fondos') renderFondosView();
  if(name==='directorio') renderDirectorioView();
}

// ======= IndexedDB
function openDB(){
  if(db) return Promise.resolve(db);
  return new Promise((resolve,reject)=>{
    const request = indexedDB.open(DB, VER);
    request.onupgradeneeded=()=>{
      const database=request.result;
      if(!database.objectStoreNames.contains('items')){
        const store=database.createObjectStore('items',{keyPath:'id'});
        store.createIndex('by_text','_t');
      }
    };
    request.onsuccess=()=>{ db=request.result; resolve(db); };
    request.onerror=()=>reject(request.error);
  });
}
async function put(o){
  await openDB();
  o._t = buildT(o);
  if(!o.id) o.id=uid();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('items','readwrite');
    const store=tx.objectStore('items');
    const req=store.put(o);
    req.onsuccess=()=>resolve(o);
    req.onerror=()=>reject(req.error);
  });
}
async function all(){
  await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('items');
    const store=tx.objectStore('items');
    const req=store.getAll();
    req.onsuccess=()=>resolve(req.result||[]);
    req.onerror=()=>reject(req.error);
  });
}
async function get(id){
  await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('items');
    const store=tx.objectStore('items');
    const req=store.get(id);
    req.onsuccess=()=>resolve(req.result||null);
    req.onerror=()=>reject(req.error);
  });
}
async function del(id){
  await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('items','readwrite');
    const store=tx.objectStore('items');
    const req=store.delete(id);
    req.onsuccess=()=>resolve(true);
    req.onerror=()=>reject(req.error);
  });
}

// ======= No. de expediente
const EXP_RE=/^(\d{4})(OP|AT|DR|DU|MU|SP|SE|TE|SA|DS|CT|PL|CM)(\d{6})$/;
function depToCode(dep){ const S=String(dep||'').toUpperCase(); const hit=DEP_CODE_MAP.find(x=>S.includes(x.match)); return hit?hit.code:'OP'; }
function _getSeqMap(){ try{ return JSON.parse(localStorage.getItem(EXP_SEQ_KEY)||'{}'); }catch{ return {}; } }
function _setSeqMap(m){ localStorage.setItem(EXP_SEQ_KEY, JSON.stringify(m||{})); }
async function _maxSerialFromDB(ejercicio,code){
  const items=await all(); const re=new RegExp(`^${ejercicio}${code}(\\d{6})$`); let max=0;
  items.forEach(r=>{ const s=String(r.no_expediente||'').trim(); const m=s.match(re); if(m){ const n=Number(m[1]||0); if(n>max) max=n; }});
  return max;
}
async function _allocNextSerial(ejercicio,code){
  const map=_getSeqMap(); const key=String(ejercicio||'').trim(); if(!key) return 1;
  const dbMax=await _maxSerialFromDB(key,code);
  const cur=Math.max(Number(map[key]||0), dbMax);
  const next=cur+1; map[key]=next; _setSeqMap(map); return next;
}
function _buildExpediente(ejercicio,code,serial){ const s6=String(Math.max(1,Number(serial||1))).padStart(6,'0'); return `${ejercicio}${code}${s6}`; }
async function computeAutoNoExpediente(force=false){
  const ej=$('#ejercicio')?.value?.trim();
  const tipo=$('#tipo_documento')?.value?.trim();
  const cont=$('#no_contrato')?.value?.trim();
  const dep=$('#dependencia')?.value?.trim();
  const code=depToCode(dep);
  const outHidden=$('#no_expediente'); const outEdit=$('#no_expediente_edit'); const outPrev=$('#exp_preview');
  if(!ej || !tipo || !cont){ if(force) toast('Ejercicio, Tipo de documento y No. de contrato son obligatorios'); return null; }
  const cur=(outHidden?.value || outEdit?.value || '').trim(); if(cur && !force) return cur;
  const DOC_AMC=(s)=>['AMPLIACIÓN','AMPLIACION','CANCELACIÓN','CANCELACION','MODIFICACIÓN','MODIFICACION'].includes(String(s||'').toUpperCase());
  if(DOC_AMC(tipo)){
    const items=await all();
    const sameYearSameContract=items.find(r=> String(r.ejercicio||'')===String(ej) &&
      String(r.no_contrato||'').trim().toUpperCase()===String(cont).trim().toUpperCase() && String(r.no_expediente||''));
    if(sameYearSameContract){
      const ne=sameYearSameContract.no_expediente;
      if(outHidden) outHidden.value=ne; if(outEdit) outEdit.value=ne; if(outPrev) outPrev.textContent=ne;
      return ne;
    }
  }
  const serial=await _allocNextSerial(ej,code);
  const ne=_buildExpediente(ej,code,serial);
  if(outHidden) outHidden.value=ne; if(outEdit) outEdit.value=ne; if(outPrev) outPrev.textContent=ne;
  return ne;
}
function syncNoExpFromEdit(){
  const edit=$('#no_expediente_edit'); if(!edit) return;
  const v=(edit.value||'').toUpperCase().replace(/\s+/g,''); edit.value=v;
  const hidden=$('#no_expediente'); if(hidden) hidden.value=v;
  const prev=$('#exp_preview'); if(prev) prev.textContent = EXP_RE.test(v) ? v : '—';
}
function parseNoExpToControls(noexp){
  const s=String(noexp||'').toUpperCase().trim();
  const edit=$('#no_expediente_edit'); const hidden=$('#no_expediente'); if(edit) edit.value=s; if(hidden) hidden.value=s;
  const prev=$('#exp_preview'); if(prev) prev.textContent = EXP_RE.test(s) ? s : '—';
}
function initNoExpControls(){
  const edit=$('#no_expediente_edit'); if(edit){ edit.addEventListener('input',syncNoExpFromEdit); edit.addEventListener('blur',syncNoExpFromEdit); syncNoExpFromEdit(); }
}

// ======= Estatus
function badge(s){
  const v=(s||'').toUpperCase();
  const pill=(cls,txt)=>`<span class="badge ${cls}" data-act-toggle>${txt}</span>`;
  if(v==='TRAMITADO') return pill('badge-green','TRAMITADO');
  if(v==='DEVOLUCIÓN' || v==='DEVOLUCION') return pill('badge-red','DEVOLUCIÓN');
  if(v==='AUTORIZADO') return pill('badge-blue','AUTORIZADO');
  return pill('badge-amber','EN TRÁMITE');
}
function computeStatus(o){
  if((o.ampliaciones?.length||0)+(o.modificaciones?.length||0)+(o.cancelaciones?.length||0)>0) return 'TRAMITADO';
  if(o.autorizaciones?.length>0) return 'AUTORIZADO';
  if(o.devoluciones?.length>0) return 'DEVOLUCIÓN';
  return 'EN TRÁMITE';
}

// ======= Dinero en inputs
function setupMoneyInputs(){
  const base=$('#importe');
  base?.addEventListener('blur',()=>{ formatMoneyInput(base); recalc(); });
  base?.addEventListener('input',()=>{ recalc(); });
  base?.addEventListener('focus',()=>{ const v=parseMoney(base.value); base.value = v? String(v):''; });
}
function setupMoneyInForm(formSel, fields){
  fields.forEach(f=>{
    const el=document.querySelector(`${formSel} [data-f="${f}"]`); if(!el) return;
    el.addEventListener('blur',()=>formatMoneyInput(el));
    el.addEventListener('focus',()=>{ const v=parseMoney(el.value); el.value = v? String(v):''; });
  });
}

// ======= Concurrencias
function addConc(v={fondo:'',importe:''}){
  const row=document.createElement('div');
  row.className='conc-item grid-2';
  row.innerHTML=`
  <div><label>Fondo</label><select data-n="fondo"></select></div>
  <div><label>Importe a concurrir</label>
    <div style="display:flex;gap:8px;align-items:center">
      <input data-n="importe" type="text" inputmode="decimal"/>
      <button class="ghost" data-rm type="button">🗑️ Quitar</button>
    </div>
  </div>`;
  $('#concWrap')?.appendChild(row);
  const sf=row.querySelector('select[data-n="fondo"]');
  const fondos=JSON.parse(localStorage.getItem(FONDOS_KEY)||'[]');
  fillSelect(sf, fondos); sf.value = v.fondo || '';
  const imp=row.querySelector('[data-n="importe"]'); imp.value = v.importe? fmt2(v.importe):'';
  const onCh=()=>{ formatMoneyInput(imp); recalc(); tryApplyConcurrenceIntoAutDialog(); };
  imp.addEventListener('blur', onCh);
  imp.addEventListener('input', ()=>{ recalc(); tryApplyConcurrenceIntoAutDialog(); });
  row.querySelector('[data-rm]').onclick=()=>{ row.remove(); recalc(); tryApplyConcurrenceIntoAutDialog(); };
}
function readConc(){
  const rows=document.querySelectorAll('#concWrap .conc-item');
  const out=[]; rows.forEach(row=>{
    const fondo=row.querySelector('[data-n="fondo"]')?.value?.trim()||'';
    const importe=parseMoney(row.querySelector('[data-n="importe"]')?.value||0);
    if(fondo || importe>0) out.push({fondo, importe});
  });
  return out;
}
function recalc(){
  const base=parseMoney($('#importe')?.value||0);
  const extra=readConc().reduce((a,c)=>a+Number(c.importe||0),0);
  const t=base+extra;
  const totalChip=$('#totalChip'); if(totalChip) totalChip.textContent = t.toLocaleString('es-MX',{style:'currency',currency:'MXN'});
}
function tryApplyConcurrenceIntoAutDialog(){ const dlg=document.getElementById('dlgAut'); if(dlg && dlg.open) applyMainConcToAutDialog(); }
function applyMainConcToAutDialog(){
  const dlg=document.getElementById('dlgAut'); const root=dlg||document;
  const cont=root.querySelector('#aut_conc_container');
  const g1=cont?.querySelector('.conc-group[data-conc="1"]');
  const g2=cont?.querySelector('.conc-group[data-conc="2"]');
  const set=(f,v)=>{ const el=root.querySelector(`#formAut [data-f="${f}"]`); if(el) el.value=v??''; };
  let concs=[]; try{ if(typeof readConc==='function') concs = readConc()||[]; }catch{}
  const c1=concs[0]||null; const c2=concs[1]||null;
  if(g1) g1.style.display='none'; if(g2) g2.style.display='none';
  ['fondo_conc_1','imp_conc_1','imp_conc1_mod','cta_cont_1','cog_1','fondo_conc_2','imp_conc_2','imp_conc2_mod','cta_cont_2','cog_2'].forEach(k=>set(k,''));
  if(c1){ set('fondo_conc_1', c1.fondo||''); set('imp_conc_1', fmt2(c1.importe||0)); set('imp_conc1_mod', fmt2(c1.importe||0)); if(g1) g1.style.display=''; }
  if(c2){ set('fondo_conc_2', c2.fondo||''); set('imp_conc_2', fmt2(c2.importe||0)); set('imp_conc2_mod', fmt2(c2.importe||0)); if(g2) g2.style.display=''; }
  if(cont){ const show=!!(c1||c2); cont.classList.toggle('hidden', !show); if(show) cont.style.display=''; }
}

// ======= Form principal
function collect(){
  return {
    id: $('#id')?.value?.trim(),
    ejercicio: $('#ejercicio')?.value,
    fecha_recepcion: $('#fecha_recepcion')?.value,
    fecha_elaboracion: $('#fecha_elaboracion')?.value,
    dependencia: $('#dependencia')?.value,
    ejecutora: $('#ejecutora')?.value?.trim(),
    no_oficio: $('#no_oficio')?.value?.trim(),
    tipo_documento: $('#tipo_documento')?.value,
    no_contrato: $('#no_contrato')?.value?.trim(),
    no_expediente: $('#no_expediente')?.value?.trim(),
    nombre_obra: $('#nombre_obra')?.value?.trim(),
    fondo: $('#fondo')?.value,
    importe: parseMoney($('#importe')?.value),
    departamento: $('#departamento')?.value?.trim(),
    responsable_tramite: $('#responsable_tramite')?.value?.trim(),
    concurrencias: readConc(),
    estatus: ($('#estatus')?.value || '').trim() || 'EN TRÁMITE',
    devoluciones: [],
    autorizaciones: [],
    ampliaciones: [],
    modificaciones: [],
    cancelaciones: []
  };
}
function fill(o){
  const map={ id:'id', ejercicio:'ejercicio', fecha_recepcion:'fecha_recepcion', fecha_elaboracion:'fecha_elaboracion',
    dependencia:'dependencia', ejecutora:'ejecutora', no_oficio:'no_oficio', tipo_documento:'tipo_documento',
    no_contrato:'no_contrato', nombre_obra:'nombre_obra', fondo:'fondo', departamento:'departamento',
    responsable_tramite:'responsable_tramite', estatus:'estatus' };
  Object.entries(map).forEach(([k,id])=>{ const el=document.getElementById(id); if(el) el.value=o[k]??''; });
  const impEl=$('#importe'); if(impEl) impEl.value = o.importe? fmt2(o.importe):'';
  parseNoExpToControls(o.no_expediente||'');
  const wrap=$('#concWrap'); if(wrap){ wrap.innerHTML=''; (o.concurrencias||[]).forEach(addConc); }
  recalc(); selectedId=o.id||null; isNewRecord=false; renderDetails();
}
async function isNoExpAutDuplicado(noexp, excludeId, currentObj){
  const items=await all(); const key=String(noexp||'').toUpperCase().trim();
  const curTipo=String(currentObj?.tipo_documento||'').toUpperCase();
  const curNombre=norm(currentObj?.nombre_obra||'');
  if(!['AUTORIZACIÓN','AUTORIZACION'].includes(curTipo)) return false;
  return items.some(r=>{
    if(r.id===excludeId) return false;
    const mismoNoExp=String(r.no_expediente||'').toUpperCase().trim()===key; if(!mismoNoExp) return false;
    const tipoR=String(r.tipo_documento||'').toUpperCase(); if(!['AUTORIZACIÓN','AUTORIZACION'].includes(tipoR)) return false;
    const nombreIgual=norm(r.nombre_obra||'')===curNombre;
    return !nombreIgual;
  });
}
async function saveMainRecord(){
  if(_savingMain) return; _savingMain=true;
  try{
    const o=collect();
    if(!o.ejercicio){ toast('Captura el Ejercicio'); return; }
    if(!o.tipo_documento){ toast('Selecciona el Tipo de Documento'); return; }
    if(!o.no_contrato?.trim()){ toast('Captura el No. Contrato'); return; }
    const ne=String(o.no_expediente||'').toUpperCase().trim(); if(!ne){ toast('Captura el No. de Expediente'); return; }
    if(['AUTORIZACIÓN','AUTORIZACION'].includes(String(o.tipo_documento||'').toUpperCase())){
      const dup=await isNoExpAutDuplicado(ne, selectedId||o.id, o);
      if(dup){ toast('Ese No. de Expediente ya está usado por otra obra. Para la misma obra sí se permite.'); return; }
    }
    const base=selectedId? await get(selectedId):null;
    const rec= base? {...base, ...o, id:selectedId} : o;
    await put(rec); selectedId=rec.id; isNewRecord=false;
    toast('Registro guardado');
    await render($('#q')?.value); await renderDetails(); await renderDashboard(); await renderAutList();
  }catch(err){ console.error(err); toast('Ocurrió un error al guardar'); }
  finally{ _savingMain=false; }
}
function newMainRecord(){
  ['#ejercicio','#fecha_recepcion','#fecha_elaboracion','#dependencia','#ejecutora','#no_oficio','#tipo_documento','#no_contrato','#nombre_obra','#fondo','#importe','#departamento','#responsable_tramite','#estatus']
    .forEach(sel=>{ const el=$(sel); if(el) el.value=''; });
  parseNoExpToControls('');
  const wrap=$('#concWrap'); if(wrap) wrap.innerHTML='';
  recalc(); selectedId=null; isNewRecord=true; hideAllPanels(); autoYear(); toast('Formulario preparado para un nuevo registro');
}

// ======= Tabla principal
function totalFinanciamiento(rec){
  const base=parseMoney(rec?.importe)||0;
  const extra=(rec?.concurrencias||[]).reduce((a,c)=>a+(parseMoney(c.importe)||0),0);
  return base+extra;
}
async function render(q=''){
  const host=$('#tabla'); if(!host) return;
  const items=await all();
  const term=String(q||'').toLowerCase();
  const rows= term? items.filter(x=>String(x._t||'').includes(term)) : items;
  host.innerHTML = `<div class="table"><table><thead>
    <tr><th>Fecha</th><th>No.Oficio</th><th>Dependencia</th><th>Nombre</th><th>Importe</th><th>Estatus</th><th>Acciones</th></tr>
  </thead><tbody>${
    rows.map(r=>{
      const est=computeStatus(r);
      const doc=(r.tipo_documento||'').toUpperCase();
      const extraBtns=[
        (doc==='AUTORIZACIÓN'||doc==='AUTORIZACION')?`<button class="small-btn" data-aut='${r.id}'>Autorización</button>`:'',
        (doc==='AMPLIACIÓN'||doc==='AMPLIACION')?`<button class="small-btn" data-amp='${r.id}'>Of. Ampliación</button>`:'',
        (doc==='CANCELACIÓN'||doc==='CANCELACION')?`<button class="small-btn" data-can='${r.id}'>Of. Cancelación</button>`:'',
        (doc==='MODIFICACIÓN'||doc==='MODIFICACION')?`<button class="small-btn" data-mod='${r.id}'>Of. Modificación</button>`:''
      ].join('');
      const actionsCell = `
        <div class="act-set" style="display:none">
          <button class="small-btn" data-e='${r.id}'>Editar</button>
          <button class="small-btn warn" data-d='${r.id}'>Eliminar</button>
          <button class="small-btn" data-dev='${r.id}'>Devolución</button>
          ${extraBtns}
        </div>
        <button class="small-btn ghost" data-act-toggle title="Mostrar acciones">⋯</button>`;
      return `<tr data-row="${r.id}">
        <td>${r.fecha_recepcion||''}</td>
        <td style="white-space:nowrap">${r.no_oficio||''}</td>
        <td>${r.dependencia||''}</td>
        <td>${r.nombre_obra||''}</td>
        <td>${fmtMoney(totalFinanciamiento(r))}</td>
        <td>${badge(est)}</td>
        <td>${actionsCell}</td>
      </tr>`;
    }).join('')
  }</tbody></table></div>`;
  hideAllPanels();
}

// ======= Paneles
const togglePanel=(el,show)=>{ if(!el) return; el.classList.toggle('active', !!show); };
const hideAllPanels=()=>{ ['#panelAut','#panelAmp','#panelMod','#panelCan','#panelDev'].forEach(id=>togglePanel($(id),false)); };

// ======= Dashboard
function donutSVG(parts){
  const list=Array.isArray(parts)?parts:[]; const total=list.reduce((a,p)=>a+(Number(p.value)||0),0)||1;
  const C=100, R=70, CX=C, CY=C, size=C*2; const NS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(NS,'svg'); svg.setAttribute('viewBox',`0 0 ${size} ${size}`); svg.setAttribute('role','img'); svg.setAttribute('aria-label','Distribución');
  let cum=0; list.forEach((p,i)=>{
    const val=Number(p.value)||0; const v=val/total;
    const start=(cum*2*Math.PI)-Math.PI/2; cum+=v; const end=(cum*2*Math.PI)-Math.PI/2;
    const x1=CX+R*Math.cos(start), y1=CY+R*Math.sin(start); const x2=CX+R*Math.cos(end), y2=CY+R*Math.sin(end);
    const large=v>0.5?1:0; const path=document.createElementNS(NS,'path');
    path.setAttribute('d',`M ${CX} ${CY} L ${x1} ${y1} A ${R} ${R} 0 ${large} 1 ${x2} ${y2} Z`);
    path.setAttribute('fill', p?.color || ['#eab308','#60a5fa','#34d399','#fca5a5'][i%4]);
    svg.appendChild(path);
  });
  const hole=document.createElementNS(NS,'circle'); hole.setAttribute('cx',String(CX)); hole.setAttribute('cy',String(CY)); hole.setAttribute('r',String(R-26)); hole.setAttribute('fill','white'); svg.appendChild(hole);
  return svg.outerHTML;
}
function color(i){ return ['#eab308','#60a5fa','#34d399','#fca5a5'][i%4]; }
async function renderDashboard(){
  const items=await all();
  const counts={recibidos:items.length, tramite:0, tramitado:0, dev:0};
  items.forEach(o=>{ const s=computeStatus(o); if(s==='EN TRÁMITE') counts.tramite++; else if(s==='TRAMITADO') counts.tramitado++; else if(s==='DEVOLUCIÓN') counts.dev++; });
  const parts=[{label:'Recibidos',value:counts.recibidos,color:color(0)},{label:'En trámite',value:counts.tramite,color:color(1)},{label:'Tramitados',value:counts.tramitado,color:color(2)},{label:'Devueltos',value:counts.dev,color:color(3)}];
  const donutWrap=$('#donutWrap'); if(donutWrap) donutWrap.innerHTML=donutSVG(parts);
  const donutLegend=$('#donutLegend'); if(donutLegend) donutLegend.innerHTML = parts.map(p=>`<div><span class="pill" style="background:${p.color};color:#111;padding:2px 6px">${p.label}</span> ${p.value}</div>`).join('');
  const kpiTotal=$('#kpiTotal'); if(kpiTotal) kpiTotal.textContent=String(items.length);
  const auts=items.flatMap(r=>r.autorizaciones||[]);
  const kpiAutos=$('#kpiAutos'); if(kpiAutos) kpiAutos.textContent=String(auts.length);
  const autMonto=auts.reduce((a,x)=>a+parseMoney(x.autorizado_mod||x.autorizado),0);
  const kpiAutMonto=$('#kpiAutMonto'); if(kpiAutMonto) kpiAutMonto.textContent=fmtMoney(autMonto);
  const kpiUpd=$('#kpiUpd'); if(kpiUpd) kpiUpd.textContent=new Date().toLocaleString('es-MX');

  const byDep={}, byFondo={};
  items.forEach(r=>{
    (r.autorizaciones||[]).forEach(a=>{
      const k=r.dependencia||'—'; byDep[k]=(byDep[k]||0)+parseMoney(a.autorizado_mod||a.autorizado);
    });
  });
  items.forEach(r=>{
    (r.autorizaciones||[]).forEach(a=>{
      const k=a.fondo || r.fondo || '—'; byFondo[k]=(byFondo[k]||0)+parseMoney(a.autorizado_mod||a.autorizado);
    });
  });

  const mkTable=(obj)=>`<table><thead><tr><th>Clave</th><th style="text-align:right">Autorizado</th></tr></thead><tbody>${
    Object.entries(obj).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<tr><td>${k}</td><td style="text-align:right">${fmtMoney(v)}</td></tr>`).join('')
  }</tbody></table>`;
  const tblByDep=$('#tblByDep'); if(tblByDep) tblByDep.innerHTML=mkTable(byDep);
  const tblByFondo=$('#tblByFondo'); if(tblByFondo) tblByFondo.innerHTML=mkTable(byFondo);
}

// ======= Vistas específicas
function renderDirectorioView(){
  const host=$('#dirTable'); if(!host) return;
  const list=JSON.parse(localStorage.getItem('deps_dir_v1')||'[]');
  const rows=list.map((x,i)=>`
    <tr>
      <td>${x.dep||'—'}</td><td>${x.director||'—'}</td><td>${x.cargo||'—'}</td>
      <td style="text-align:right;white-space:nowrap">
        <button class="small-btn" data-dir-edit="${i}">Editar</button>
        <button class="small-btn warn" data-dir-del="${i}">Eliminar</button>
      </td>
    </tr>`).join('');
  host.innerHTML=`
    <table><thead>
      <tr><th>Dependencia</th><th>Director(a)</th><th>Cargo</th><th style="width:140px;text-align:right">Acciones</th></tr>
    </thead><tbody>${rows || `<tr><td colspan="4" style="text-align:center;color:#64748b">Sin datos</td></tr>`}</tbody></table>`;
}
function renderFondosView(){
  const host=$('#fondosTable'); if(!host) return;
  const data=readFondosMeta();
  const rows=data.map(m=>{
    const editing=fondosEditCode===m.code;
    if(!editing){
      return `<tr data-fondo-row="${m.code}">
        <td style="width:220px">${m.code}</td><td>${m.full_name||'—'}</td>
        <td style="text-align:right;white-space:nowrap">
          <button class="small-btn blue" data-fondo-edit="${m.code}">Editar</button>
          <button class="small-btn warn" data-fondo-del="${m.code}">Eliminar</button>
        </td></tr>`;
    }
    return `<tr data-fondo-row="${m.code}">
      <td><input class="w-full" data-fondo-code-edit value="${m.code}" /></td>
      <td><input class="w-full" data-fondo-name-edit value="${m.full_name||''}" placeholder="Nombre completo" /></td>
      <td style="text-align:right;white-space:nowrap">
        <button class="small-btn" data-fondo-save="${m.code}">Guardar</button>
        <button class="small-btn ghost" data-fondo-cancel>Cancelar</button>
      </td></tr>`;
  }).join('');
  const newRow=`<tr>
    <td><input id="new_fondo_code" class="w-full" placeholder="Nuevo fondo (código)"/></td>
    <td><input id="new_fondo_name" class="w-full" placeholder="Nombre completo"/></td>
    <td style="text-align:right"><button class="small-btn" data-fondo-add>Agregar</button></td>
  </tr>`;
  host.innerHTML=`<table><thead><tr><th>Código</th><th>Nombre del fondo</th><th></th></tr></thead><tbody>${rows||''}${newRow}</tbody></table>`;
}

// ======= Inicialización
document.addEventListener('DOMContentLoaded', ()=>{
  const boot = async ()=>{
    try{
      seedCatalogs();
      autoYear();
      setupMoneyInputs();
      initNoExpControls();
      await render('');
      await renderDashboard();
      renderDirectorioView();
      renderFondosView();
      await renderAutList();
      ensureMainMenu();
      attachContratoAutoFillMain(); // activa el autofill cuando capturas No. de contrato
    }catch(err){ console.error('Error boot()',err); toast('Ocurrió un error al iniciar la app'); }
  };
  const showApp=()=>{ $('#login')?.classList.add('oculto'); $('#app')?.classList.remove('oculto'); };
  const showLogin=()=>{ $('#login')?.classList.remove('oculto'); $('#app')?.classList.add('oculto'); };
  const doLogin=async(e)=>{
    e?.preventDefault?.();
    const user=($('#u')?.value||'').trim(); const pass=($('#p')?.value||'').trim();
    if(user==='admin' && pass==='1234'){ localStorage.setItem('session_user',user); showApp(); await boot(); }
     else { toast('Usuario o contraseña incorrectos'); }
  };
  $('#loginBtn')?.addEventListener('click', doLogin);
  $('#u')?.addEventListener('keydown',(e)=>{ if(e.key==='Enter') doLogin(e); });
  $('#p')?.addEventListener('keydown',(e)=>{ if(e.key==='Enter') doLogin(e); });
  if(localStorage.getItem('session_user')){ showApp(); boot(); } else { showLogin(); }
});

// ======= Delegación de eventos global
document.addEventListener('click', async (e)=>{
  // Toggle acciones — FIX: impedir burbujas y usar block/none
  const tgl=e.target.closest?.('[data-act-toggle]');
  if(tgl){
    e.stopPropagation();
    if(typeof e.stopImmediatePropagation==='function') e.stopImmediatePropagation();
    const tr=tgl.closest('tr'); const panel=tr?.querySelector('.act-set');
    if(panel){
      const visible = panel.style.display !== 'none' && panel.style.display !== '';
      panel.style.display = visible ? 'none' : 'block';
    }
    return;
  }

  // Seleccionar fila
  const row=e.target.closest?.('tr[data-row]');
  if(row && !e.target.closest('button')){
    selectedId=row.getAttribute('data-row');
    await renderDetails();
    return;
  }

  // Botones acción
  const ed=e.target.closest?.('[data-e]');
  const rm=e.target.closest?.('[data-d]');
  const dv=e.target.closest?.('[data-dev]');
  const au=e.target.closest?.('[data-aut]');
  const amp=e.target.closest?.('[data-amp]');
  const mod=e.target.closest?.('[data-mod]');
  const can=e.target.closest?.('[data-can]');

  if(ed){ const id=ed.getAttribute('data-e'); const o=await get(id); if(o) fill(o); return; }
  if(rm){
    const id=rm.getAttribute('data-d');
    if(confirm('¿Eliminar registro?')){
      await del(id);
      if(selectedId===id) selectedId=null;
      await render($('#q')?.value); hideAllPanels(); await renderDashboard(); await renderAutList();
    }
    return;
  }
  // (otros handlers se declaran en PARTE 2)
});


// ========= FUNCIONES DE AUTORIZACIONES =========//
async function renderAutList() {
    const items = await all();

    const AUT_YEARS_STATE_KEY = 'aut_years_open_v1';
    const AUT_FILTERS_KEY = 'aut_filters_v1';
    const AUT_DEPYEAR_OPEN_KEY = 'aut_dep_year_open_v1';

    const getYearOpenMap = () => {
        try { return JSON.parse(localStorage.getItem(AUT_YEARS_STATE_KEY) || '{}'); } catch { return {}; }
    };
    const setYearOpenMap = (m) => localStorage.setItem(AUT_YEARS_STATE_KEY, JSON.stringify(m || {}));

    const getAutFilters = () => {
        try { return JSON.parse(localStorage.getItem(AUT_FILTERS_KEY) || '{}'); } catch { return {}; }
    };
    const setAutFilters = (f) => localStorage.setItem(AUT_FILTERS_KEY, JSON.stringify(f || {}));

    const getDepYearOpen = () => {
        try { return JSON.parse(localStorage.getItem(AUT_DEPYEAR_OPEN_KEY) || '{}'); } catch { return {}; }
    };
    const setDepYearOpen = (m) => localStorage.setItem(AUT_DEPYEAR_OPEN_KEY, JSON.stringify(m || {}));

    const depYearOpenState = getDepYearOpen();

    // Construir filas
    const rows = [];
    for (const r of items) {
        const ej = r.ejercicio || '—';
        const dep = r.dependencia || '—';
        for (const a of (r.autorizaciones || [])) {
            const fondo = a.fondo || r.fondo || '—';
            const autN = parseMoney(a.autorizado_mod || a.autorizado);
            const invN = await computeInvModGlobal(r.no_expediente, autN, fondo);

            rows.push({
                recId: r.id,
                ejercicio: ej,
                dependencia: dep,
                fondo,
                oficio: a.oficio_aut || '—',
                id_proyecto: a.id_proyecto || r.no_expediente || '—',
                nombre_obra: r.nombre_obra || '—',
                autorizadoN: autN,
                autorizadoTxt: fmtMoney(autN),
                invModN: invN,
                invModTxt: fmtMoney(invN),
                autId: a.id_unico
            });
        }
    }

    // Totales para sidebar
    const totals = {};
    const addT = (ej, fondo, val) => {
        const E = (totals[ej] ||= { total: 0, fondos: {} });
        E.total += val;
        E.fondos[fondo] = (E.fondos[fondo] || 0) + val;
    };
    rows.forEach(r => addT(r.ejercicio, r.fondo, r.invModN));
    const totalGlobal = rows.reduce((a, x) => a + x.invModN, 0);

    // Sidebar
    const side = document.getElementById('autSidebar');
    const autFilters = getAutFilters();
    const yearOpen = getYearOpenMap();

    if (side) {
        const yearList = Object.keys(totals).sort((a, b) => String(b).localeCompare(String(a)));
        const mkChip = (html, active = false) =>
            `<button class="chip${active ? ' active' : ''}" type="button">${html}</button>`;

        const blocks = [];

        blocks.push(
            `<div>${mkChip(
                `<span>All</span><span class="pill money">${fmtMoney(totalGlobal)}</span>`,
                !autFilters.year && !autFilters.fund
            )}</div>`
        );

        for (const ej of yearList) {
            const isOpen = yearOpen[ej] !== false;
            const ejChip = `
                <button class="chip year ${isOpen ? 'open' : ''}" data-ej="${ej}" type="button">
                    <span style="display:flex;gap:8px;align-items:center">
                        <span class="caret"></span><span>${ej}</span>
                    </span>
                    <span class="pill money">${fmtMoney(totals[ej].total)}</span>
                </button>`;

            const fondos = Object.entries(totals[ej].fondos).sort((a, b) => a[0].localeCompare(b[0]));
            const fundsHTML = fondos.map(([code, v]) =>
                `<button class="chip sub${(autFilters.year === ej && autFilters.fund === code) ? ' active' : ''}" data-ej="${ej}" data-fondo="${code}" type="button">
                    <span>${code}</span><span class="pill money">${fmtMoney(v)}</span>
                </button>`
            ).join('');

            blocks.push(
                `<div class="year-block" data-ej="${ej}">
                   ${ejChip}
                   <div class="funds ${isOpen ? '' : 'hidden'}">${fundsHTML}</div>
                 </div>`
            );
        }

        side.innerHTML = blocks.join('');

        side.querySelector('button.chip:not([data-ej])')?.addEventListener('click', () => {
            setAutFilters({});
            renderAutList();
        });
        side.querySelectorAll('button.chip.year').forEach(btn => {
            btn.addEventListener('click', () => {
                const ej = btn.getAttribute('data-ej');
                yearOpen[ej] = !(yearOpen[ej] !== false);
                setYearOpenMap(yearOpen);
                const wrap = side.querySelector(`.year-block[data-ej="${ej}"] .funds`);
                if (wrap) wrap.classList.toggle('hidden', !yearOpen[ej]);
            });
        });
        side.querySelectorAll('button.chip.sub').forEach(btn => {
            btn.addEventListener('click', () => {
                const ej = btn.getAttribute('data-ej');
                const f = btn.getAttribute('data-fondo');
                setAutFilters({ year: ej, fund: f });
                renderAutList();
            });
        });
    }

    // Filtros + búsqueda
    let filtered = rows.slice();
    if (autFilters.year) filtered = filtered.filter(r => String(r.ejercicio) === String(autFilters.year));
    if (autFilters.fund) filtered = filtered.filter(r => String(r.fondo) === String(autFilters.fund));

    const q = (document.getElementById('autListQ')?.value || '').toLowerCase().trim();
    if (q) {
        filtered = filtered.filter(r => {
            const t = [r.oficio, r.id_proyecto, r.nombre_obra, r.dependencia, r.fondo, r.ejercicio].join('|').toLowerCase();
            return t.includes(q);
        });
    }

    // Agrupar para tabla: Dependencia → Ejercicio
    const byDep = {};
    filtered.forEach(r => {
        const D = (byDep[r.dependencia] ||= {});
        (D[r.ejercicio] ||= []).push(r);
    });

    // Render tabla
    const host = document.getElementById('autListTable');
    if (!host) return;

    const sections = [];
    const mkDepKey = (dep, ej) => `${dep}||${ej}`;
    const isOpenDepYear = (dep, ej) => depYearOpenState[mkDepKey(dep, ej)] !== false;

    for (const dep of Object.keys(byDep).sort()) {
        const yearsObj = byDep[dep];

        const depTotal = Object.values(yearsObj).flat().reduce((a, x) => a + x.autorizadoN, 0);

        sections.push(
            `<tr class="group-row">
                 <td colspan="6">
                   <strong>${dep}</strong>
                   <span class="pill right">${fmtMoney(depTotal)}</span>
                 </td>
               </tr>`
        );

        for (const ej of Object.keys(yearsObj).sort()) {
            const list = yearsObj[ej];
            const ejAut = list.reduce((a, x) => a + x.autorizadoN, 0);
            const ejInv = list.reduce((a, x) => a + x.invModN, 0);
            const open = isOpenDepYear(dep, ej);

            sections.push(
                `<tr class="sub" data-dep="${dep}" data-ej="${ej}" data-toggle-ej>
                   <td colspan="6" style="color:#6b7280;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
                     <span style="display:flex;gap:8px;align-items:center">
                       <span class="caret" style="display:inline-block;width:0;height:0;border-left:6px solid #374151;border-top:4px solid transparent;border-bottom:4px solid transparent;transform:rotate(${open ? 90 : 0}deg);transition:.18s"></span>
                       <span>Ejercicio ${ej}</span>
                     </span>
                     <span>
                       <span class="pill" style="margin-right:6px">${fmtMoney(ejAut)}</span>
                       <span class="pill">${fmtMoney(ejInv)}</span>
                     </span>
                   </td>
                 </tr>`
            );

            for (const r of list) {
                sections.push(
                    `<tr class="ej-row ${open ? '' : 'hidden'}" data-parent-dep="${dep}" data-parent-ej="${ej}" data-rec-id="${r.recId}" data-aut-id="${r.autId}">
                      <td style="white-space:nowrap">${r.oficio}</td>
                      <td style="white-space:nowrap">${r.id_proyecto}</td>
                      <td>${r.nombre_obra || '—'}</td>
                      <td style="text-align:right">${r.autorizadoTxt}</td>
                      <td style="text-align:right">${r.invModTxt}</td>
                      <td class="row-actions" style="white-space:nowrap;text-align:right">
                        <button class="small-btn" data-aut-ficha="${r.autId}" data-record="${r.recId}">Ficha</button>
                        <button class="small-btn" data-aut-oficio="${r.autId}" data-record="${r.recId}">Oficio</button>
                      </td>
                    </tr>`
                );
            }
        }
    }

    host.innerHTML = `
        <div class="table"><table>
          <thead>
            <tr>
              <th>Oficio de autorización</th>
              <th>ID_Proyecto</th>
              <th>Nombre de la obra</th>
              <th style="text-align:right">Autorizado</th>
              <th style="text-align:right">Inversión Modificada</th>
              <th style="text-align:right">Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${sections.join('') || `<tr><td colspan="6" style="text-align:center;color:#64748b">Sin resultados</td></tr>`}
          </tbody>
        </table></div>`;

    const qInp = document.getElementById('autListQ');
    if (qInp && !qInp._bound_autlist) {
        qInp._bound_autlist = true;
        qInp.addEventListener('input', () => {
            clearTimeout(qInp._t);
            qInp._t = setTimeout(renderAutList, 200);
        });
    }

    host.querySelectorAll('[data-toggle-ej]').forEach(row => {
        row.addEventListener('click', () => {
            const dep = row.getAttribute('data-dep');
            const ej = row.getAttribute('data-ej');
            const key = mkDepKey(dep, ej);
            const open = !(depYearOpenState[key] !== false);
            depYearOpenState[key] = open;
            setDepYearOpen(depYearOpenState);

            const car = row.querySelector('.caret');
            if (car) car.style.transform = `rotate(${open ? 90 : 0}deg)`;

            host.querySelectorAll(`tr.ej-row[data-parent-dep="${CSS.escape(dep)}"][data-parent-ej="${CSS.escape(ej)}"]`)
                .forEach(tr => tr.classList.toggle('hidden', !open));
        });
    });

    document.getElementById('autListRefresh')?.addEventListener('click', () => renderAutList());
}

// ========= FUNCIONES DE MOVIMIENTOS LIGADOS =========
const sumBy = (arr = [], key) => (arr || []).reduce((a, x) => a + parseMoney(x[key]), 0);

async function collectLinkedMovs(noexp, fondo) {
    const items = await all();
    const ne = String(noexp || '').toUpperCase().trim();
    const fk = String(fondo || '').toUpperCase().trim();
    const linked = items.filter(it => String(it.no_expediente || '').toUpperCase().trim() === ne);
    const amps = [], mods = [], cans = [];
    linked.forEach(r => {
        (r.ampliaciones || []).forEach(a => { if (!fk || String(a.fondo || r.fondo || '').toUpperCase().trim() === fk) amps.push(a); });
        (r.modificaciones || []).forEach(a => { if (!fk || String(a.fondo || r.fondo || '').toUpperCase().trim() === fk) mods.push(a); });
        (r.cancelaciones || []).forEach(a => { if (!fk || String(a.fondo || r.fondo || '').toUpperCase().trim() === fk) cans.push(a); });
    });
    return { amps, mods, cans };
}

async function computeLinkedSums(noexp, fondo) {
    const { amps, mods, cans } = await collectLinkedMovs(noexp, fondo);
    return {
        amps: sumBy(amps, 'ampliacion_autorizada'),
        mods: sumBy(mods, 'modificacion_autorizada'),
        cans: sumBy(cans, 'cancelacion_autorizada')
    };
}

async function computeInvModGlobal(noexp, autorizadoNumber, fondo) {
    const { amps, cans, mods } = await computeLinkedSums(noexp, fondo);
    const aut = Number(autorizadoNumber || 0);
    return aut + amps - cans + mods;
}

// ========= FUNCIONES DE AUTOFILL =========
async function findRecordByContract(no_contrato) {
    const items = await all();
    const key = norm(no_contrato);
    const matches = items.filter(r => norm(r.no_contrato) === key);
    if (!matches.length) return null;
    const withAut = matches.filter(m => (m.autorizaciones || []).length);
    const list = withAut.length ? withAut : matches;
    const dt = r => new Date(r.fecha_recepcion || r.fecha_elaboracion || '1970-01-01');
    list.sort((a, b) => dt(b) - dt(a));
    return list[0];
}

async function computeVigente(rec) {
    const auts = rec.autorizaciones || [];
    if (!auts.length) return 0;
    const last = auts[auts.length - 1];
    const base = parseMoney(last.autorizado_mod || last.autorizado);
    const fondoClave = last.fondo || rec.fondo;
    return await computeInvModGlobal(rec.no_expediente, base, fondoClave);
}

async function applyContractToMainForm(rec) {
    if (!rec) return;
    if ($('#dependencia')) $('#dependencia').value = rec.dependencia || '';
    if ($('#ejecutora')) $('#ejecutora').value = rec.ejecutora || '';
    parseNoExpToControls(rec.no_expediente || '');
    if ($('#nombre_obra')) $('#nombre_obra').value = rec.nombre_obra || '';
    if ($('#fondo')) $('#fondo').value = rec.fondo || '';
    const inv = await computeVigente(rec);
    if ($('#importe')) $('#importe').value = fmt2(inv);
    recalc();
}

async function findRecordByExpediente(noexp) {
    const items = await all();
    const key = String(noexp || '').toUpperCase().trim();
    const matches = items.filter(r => String(r.no_expediente || '').toUpperCase().trim() === key);
    if (!matches.length) return null;
    const dt = r => new Date(r.fecha_recepcion || r.fecha_elaboracion || '1970-01-01');
    matches.sort((a, b) => dt(b) - dt(a));
    return matches[0];
}

async function applyExpedienteToDialog(kind, rec) {
    if (!rec) return;
    const map = {
        amp: { form: '#formAmp', dep: '#amp_direccion', fondo: '#amp_fondo' },
        mod: { form: '#formMod', dep: '#mod_direccion', fondo: '#mod_fondo' },
        can: { form: '#formCan', dep: '#can_direccion', fondo: '#can_fondo' },
    };
    const m = map[kind];
    if (!m) return;

    if (document.querySelector(m.dep)) document.querySelector(m.dep).value = rec.dependencia || '';
    const fSel = m.form;
    const set = (f, v) => { const el = document.querySelector(`${fSel} [data-f="${f}"]`); if (el) el.value = v || ''; };
    set('nombre_obra', rec.nombre_obra || '');
    set('id_proyecto', rec.no_expediente || '');
    if (document.querySelector(m.fondo)) document.querySelector(m.fondo).value = rec.fondo || '';

    const invVig = await computeVigente(rec);
    const invEl = document.querySelector(`${fSel} [data-f="inversion_modificada"]`);
    if (invEl) invEl.value = fmt2(invVig);

    toast('Expediente aplicado');
}

function attachExpedienteAutoFillInDialog(kind) {
    const formSel = kind === 'amp' ? '#formAmp' : kind === 'mod' ? '#formMod' : '#formCan';
    const inp = document.querySelector(`${formSel} [data-f="id_proyecto"]`);
    if (!inp) return;

    let last = '';
    const handler = async () => {
        const v = String(inp.value || '').toUpperCase().trim();
        if (!v || v === last) return;
        const rec = await findRecordByExpediente(v);
        if (!rec) { toast('Expediente no encontrado'); return; }
        await applyExpedienteToDialog(kind, rec);
        last = v;
    };
    inp.addEventListener('blur', handler);
    inp.addEventListener('input', () => {
        clearTimeout(inp._t);
        inp._t = setTimeout(handler, 300);
    });
}

function isAmpModCan() {
    const t = ($('#tipo_documento')?.value || '').toUpperCase();
    return ['AMPLIACIÓN', 'AMPLIACION', 'CANCELACIÓN', 'CANCELACION', 'MODIFICACIÓN', 'MODIFICACION'].includes(t);
}

function attachContratoAutoFillMain() {
    const inp = $('#no_contrato');
    if (!inp) return;

    let last = '';
    const tryFill = async () => {
        if (!isAmpModCan()) return;
        const v = inp.value.trim();
        if (!v || v === last) return;

        const rec = await findRecordByContract(v);
        if (!rec) { toast('Contrato no encontrado'); return; }

        await applyContractToMainForm(rec);
        toast('Información del contrato aplicada');
        last = v;
    };

    inp.addEventListener('blur', tryFill);
    inp.addEventListener('change', tryFill);
    inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); tryFill(); } });
}

const boot = async () => {
  try {
    seedCatalogs();
    autoYear();
    setupMoneyInputs();
    initNoExpControls();
    await render('');
    await renderDashboard();
    renderDirectorioView();
    renderFondosView();
    await renderAutList();
    ensureMainMenu();
    attachContratoAutoFillMain();   // 👈 ACTIVAR AUTOFILL POR CONTRATO
  } catch (err) {
    console.error('Error boot()', err);
    toast('Ocurrió un error al iniciar la app');
  }
};


// ---- helper global para prellenar concurrencias en el modal Aut ----
function AUT_prefillConcurrencesFromRecord(rec) {
  const set = (f, v) => {
    const el = document.querySelector(`#formAut [data-f="${f}"]`);
    if (el) el.value = v ?? '';
  };

  // limpia
  [
    'fondo_conc_1','imp_conc_1','imp_conc1_mod','cta_cont_1','cog_1',
    'fondo_conc_2','imp_conc_2','imp_conc2_mod','cta_cont_2','cog_2'
  ].forEach(k => set(k, ''));

  const c1 = rec?.concurrencias?.[0];
  const c2 = rec?.concurrencias?.[1];

  if (c1) {
    set('fondo_conc_1', c1.fondo || '');
    set('imp_conc_1', fmt2(parseMoney(c1.importe)));
    set('imp_conc1_mod', fmt2(parseMoney(c1.importe)));
  }
  if (c2) {
    set('fondo_conc_2', c2.fondo || '');
    set('imp_conc_2', fmt2(parseMoney(c2.importe)));
    set('imp_conc2_mod', fmt2(parseMoney(c2.importe)));
  }

  showAutConcGroups({
    fondo_conc_1: c1?.fondo, imp_conc_1: c1?.importe, imp_conc1_mod: c1?.importe,
    fondo_conc_2: c2?.fondo, imp_conc_2: c2?.importe, imp_conc2_mod: c2?.importe
  });
}



// ========= FUNCIONES DE DIALOGOS AUT/LIKE =========
async function openAutLike(kindBtn, kind) {
    const attrMap = { aut: 'data-aut', amp: 'data-amp', mod: 'data-mod', can: 'data-can' };
    const idAttr = attrMap[kind] || 'data-aut';
    const id = kindBtn.getAttribute(idAttr);
    const o = await get(id);
    if (!o) return;

    selectedId = id;
    await renderDetails();

    const fondos = JSON.parse(localStorage.getItem(FONDOS_KEY) || '[]');

    // AUTORIZACIÓN
if (kind === 'aut') {
  const fondos = JSON.parse(localStorage.getItem(FONDOS_KEY) || '[]');

  // llena catálogo para todos los selects del modal
  fillSelect($('#aut_fondo'), fondos);
  document
    .querySelectorAll('#formAut select[data-f="fondo_conc_1"], #formAut select[data-f="fondo_conc_2"]')
    .forEach(el => fillSelect(el, fondos));

  setFormValues('#formAut', {}); // limpia

  if ($('#aut_id_unico')) $('#aut_id_unico').value = 'OA-' + Math.random().toString(36).slice(2, 8).toUpperCase();
  if ($('#aut_id_proy')) $('#aut_id_proy').value = o.no_expediente || '';
  if ($('#aut_ejercicio')) $('#aut_ejercicio').value = o.ejercicio || new Date().getFullYear();
  if ($('#aut_direccion')) $('#aut_direccion').value = o.dependencia || '';
  if ($('#aut_nombre_obra')) $('#aut_nombre_obra').value = o.nombre_obra || '';
  if ($('#aut_fondo')) $('#aut_fondo').value = o.fondo || '';
  if ($('#aut_autorizado')) $('#aut_autorizado').value = fmt2(o.importe || 0);

  const invEl = document.querySelector('#formAut [data-f="inversion_modificada"]');
  if (invEl) invEl.value = fmt2(parseMoney($('#aut_autorizado')?.value));

  setupMoneyInForm('#formAut', [
    'autorizado', 'autorizado_mod', 'inversion_modificada',
    'imp_conc_1', 'imp_conc1_mod', 'imp_conc_2', 'imp_conc2_mod'
  ]);

  // ⬅️ prellenar concurrencias DIRECTO del registro seleccionado
  AUT_prefillConcurrencesFromRecord(o);

  const dlg = document.getElementById('dlgAut');
  if (dlg?.showModal) dlg.showModal();

  // ya no dependemos del formulario principal; esto lo puedes dejar o quitar
  // applyMainConcToAutDialog();

  AUT_bindHandlers();      // recalcula inversión base, listeners, etc.
  AUT_recalcInvMod();
  return;
}


    // AMPLIACIÓN
    if (kind === 'amp') {
        fillSelect($('#amp_fondo'), fondos);
        setFormValues('#formAmp', {});
        if ($('#amp_id_ampliacion')) $('#amp_id_ampliacion').value = 'AM-' + Math.random().toString(36).slice(2, 8).toUpperCase();
        if ($('#amp_direccion')) $('#amp_direccion').value = o.dependencia || '';
        if ($('#formAmp [data-f="nombre_obra"]')) $('#formAmp [data-f="nombre_obra"]').value = o.nombre_obra || '';
        if ($('#formAmp [data-f="id_proyecto"]')) $('#formAmp [data-f="id_proyecto"]').value = o.no_expediente || '';
        if ($('#amp_fondo')) $('#amp_fondo').value = o.fondo || '';
        setupMoneyInForm('#formAmp', ['ampliacion_autorizada', 'ampliacion_concertado_1', 'ampliacion_concertado_2']);
        $('#dlgAmp')?.showModal();
        attachExpedienteAutoFillInDialog('amp');
        return;
    }

    // MODIFICACIÓN
    if (kind === 'mod') {
        fillSelect($('#mod_fondo'), fondos);
        setFormValues('#formMod', {});
        if ($('#mod_id_modificacion')) $('#mod_id_modificacion').value = 'MD-' + Math.random().toString(36).slice(2, 8).toUpperCase();
        if ($('#mod_direccion')) $('#mod_direccion').value = o.dependencia || '';
        if ($('#formMod [data-f="nombre_obra"]')) $('#formMod [data-f="nombre_obra"]').value = o.nombre_obra || '';
        if ($('#formMod [data-f="id_proyecto"]')) $('#formMod [data-f="id_proyecto"]').value = o.no_expediente || '';
        if ($('#mod_fondo')) $('#mod_fondo').value = o.fondo || '';
        setupMoneyInForm('#formMod', ['modificacion_autorizada', 'modificacion_concertado_1', 'modificacion_concertado_2']);
        $('#dlgMod')?.showModal();
        attachExpedienteAutoFillInDialog('mod');
        return;
    }

    // CANCELACIÓN
    if (kind === 'can') {
        fillSelect($('#can_fondo'), fondos);
        setFormValues('#formCan', {});
        if ($('#can_id_cancelacion')) $('#can_id_cancelacion').value = 'CN-' + Math.random().toString(36).slice(2, 8).toUpperCase();
        if ($('#can_direccion')) $('#can_direccion').value = o.dependencia || '';
        if ($('#formCan [data-f="nombre_obra"]')) $('#formCan [data-f="nombre_obra"]').value = o.nombre_obra || '';
        if ($('#formCan [data-f="id_proyecto"]')) $('#formCan [data-f="id_proyecto"]').value = o.no_expediente || '';
        if ($('#can_fondo')) $('#can_fondo').value = o.fondo || '';
        setupMoneyInForm('#formCan', ['cancelacion_autorizada', 'cancelacion_concertado_1', 'cancelacion_concertado_2']);
        try { setupCancelacionMoneyInputs(); } catch { }
        $('#dlgCan')?.showModal();
        attachExpedienteAutoFillInDialog('can');
        return;
    }
}

// ========= FUNCIONES DE AUTORIZACIÓN =========
// helpers (déjalos una sola vez en el archivo)
function aut_q(sel) { return document.querySelector(sel); }
function aut_f(name) { return aut_q(`#formAut [data-f="${name}"]`); }
const nMoney = s => Number(String(s || '').replace(/[^0-9.]/g, '')) || 0;

// ⬇️ Reemplazo de AUT_recalcInvMod (ya NO suma concurrencias)
function AUT_recalcInvMod() {
  // Inversión modificada (del fondo base) = autorizado_mod (si existe) o autorizado
  const base =
    nMoney(aut_f('autorizado_mod')?.value) ||
    nMoney(aut_f('autorizado')?.value);

  const out = aut_f('inversion_modificada');
  if (out) out.value = fmt2(base);
}

// Esta función no cambia; puedes dejar la tuya tal cual
function AUT_toggleOficioEstatal() {
  const sel = aut_q('#aut_es_estatal');
  const wNo = aut_q('#grp_aut_estatal');
  const wFe = aut_q('#grp_fecha_aut');
  if (!sel || !wNo || !wFe) return;

  const v = String(sel.value || '').toLowerCase();
  const show = (v === 'sí' || v === 'si' || v === 'true' || v === '1' || v === 'yes');
  wNo.classList.toggle('hidden', !show);
  wFe.classList.toggle('hidden', !show);

  if (!show) {
    aut_f('oficio_aut_estatal') && (aut_f('oficio_aut_estatal').value = '');
    aut_f('fecha_aut') && (aut_f('fecha_aut').value = '');
  }
}

function AUT_bindHandlers() {
    [
        'autorizado', 'autorizado_mod',
        'imp_conc_1', 'imp_conc_1_mod',
        'imp_conc_2', 'imp_conc_2_mod'
    ].forEach(name => {
        const el = aut_f(name);
        if (!el) return;
        const h = () => AUT_recalcInvMod();
        el.removeEventListener?.('input', h); el.addEventListener('input', h);
        el.removeEventListener?.('blur', h); el.addEventListener('blur', h);
    });

    const sel = aut_q('#aut_es_estatal');
    if (sel) {
        sel.removeEventListener?.('change', AUT_toggleOficioEstatal);
        sel.addEventListener('change', AUT_toggleOficioEstatal);
    }

    AUT_recalcInvMod();
    AUT_toggleOficioEstatal();
}

function showAutConcGroups(autObj) {
    const cont = document.getElementById('aut_conc_container');
    const w1 = findAutConcWrap(1);
    const w2 = findAutConcWrap(2);

    const has1 = !!autObj && (
        parseMoney(autObj.imp_conc_1) > 0 ||
        parseMoney(autObj.imp_conc1_mod) > 0 ||
        !!(autObj.fondo_conc_1 || autObj.cta_cont_1 || autObj.cog_1)
    );
    const has2 = !!autObj && (
        parseMoney(autObj.imp_conc_2) > 0 ||
        parseMoney(autObj.imp_conc2_mod) > 0 ||
        !!(autObj.fondo_conc_2 || autObj.cta_cont_2 || autObj.cog_2)
    );

    if (w1) w1.style.display = has1 ? '' : 'none';
    if (w2) w2.style.display = has2 ? '' : 'none';

    if (cont) {
        const show = has1 || has2;
        cont.classList.toggle('hidden', !show);
        if (show) cont.style.display = '';
    }
}

function findAutConcWrap(n) {
    const cont = document.getElementById('aut_conc_container');
    if (cont) {
        const wrap = cont.querySelector(`.conc-group[data-conc="${n}"]`);
        if (wrap) return wrap;
    }

    const form = document.getElementById('formAut') || document;
    const sel = [
        `[data-f="imp_conc_${n}"]`,
        `[data-f="imp_conc${n}_mod"]`,
        `[data-f="imp_concertado_${n}"]`,
        `[data-f="imp_concertado${n}"]`,
        `[data-f="imp_concertado_${n}_mod"]`,
        `[data-f="imp_concertado${n}_mod"]`
    ].join(',');

    const inp = form.querySelector(sel);
    if (!inp) return null;
    return inp.closest('.conc-group') || inp.closest('.grid-4') || inp.closest('div');
}

// ========= FUNCIONES DE GUARDADO =========
// Guardar AUTORIZACIÓN
$('#btnAutSave')?.addEventListener('click', async () => {
    if (!selectedId) return;

    const base = await get(selectedId);
    if (!base) return;

    const a = getFormValues('#formAut');

    // Normaliza importes
    [
        'autorizado', 'autorizado_mod', 'inversion_modificada',
        'imp_conc_1', 'imp_conc_1_mod', 'imp_conc_2', 'imp_conc_2_mod'
    ].forEach(k => { if (k in a) a[k] = fmt2(parseMoney(a[k])); });

    const num = s => parseMoney(s);
    const moneyOr = (mod, baseV) => fmt2(num(mod) > 0 ? num(mod) : num(baseV));
    const today = () => new Date().toISOString().slice(0, 10);
    const isABIO = s => /ABIO/i.test(String(s || ''));

    // Helpers
    const upsert = (arr, row) => {
        let idx = -1;
        if (row.id_unico) idx = arr.findIndex(x => String(x.id_unico) === String(row.id_unico));
        if (idx < 0 && row.oficio_aut) idx = arr.findIndex(x => String(x.oficio_aut || '') === String(row.oficio_aut || '') && String(x.fondo || '') === String(row.fondo || ''));
        if (idx >= 0) arr[idx] = row; else arr.push(row);
    };
    const mkId = () => 'OA-' + Math.random().toString(36).slice(2, 8).toUpperCase();

    const id_proyecto = a.id_proyecto || $('#aut_id_proy')?.value || base.no_expediente || '';
    const fecha_creacion = a.fecha_creacion || today();

  // 1) AUTORIZACIÓN PRINCIPAL
const main_aut = moneyOr(a.autorizado_mod, a.autorizado);
const main_inv = moneyOr(a.inversion_modificada, main_aut);
const main_row = {
  id_unico: a.id_unico || mkId(),
  id_proyecto,
  fecha_creacion,
  ejercicio: a.ejercicio || base.ejercicio || new Date().getFullYear(),
  dependencia: a.direccion || a.dependencia || base.dependencia || '',
  nombre_obra: a.nombre_obra || base.nombre_obra || '',
  fondo: a.fondo || base.fondo || '',
  oficio_aut: a.oficio_aut || '',
  folio_sifais: a.folio_sifais || '',
  cta_contable: a.cta_contable || '',
  cog: a.cog || '',
  autorizado: main_aut,
  autorizado_mod: main_aut,
  inversion_modificada: main_inv,
  // 👇👇👇  CAMPOS ESPEJO PARA EDITAR DESPUÉS  👇👇👇
  oficio_aut_1: a.oficio_aut_1 || '',
  fondo_conc_1: a.fondo_conc_1 || '',
  imp_conc_1: fmt2(num(a.imp_conc_1)),
  imp_conc1_mod: fmt2(num(a.imp_conc_1_mod)),
  cta_cont_1: a.cta_cont_1 || '',
  cog_1: a.cog_1 || '',
  oficio_aut_2: a.oficio_aut_2 || '',
  fondo_conc_2: a.fondo_conc_2 || '',
  imp_conc_2: fmt2(num(a.imp_conc_2)),
  imp_conc2_mod: fmt2(num(a.imp_conc_2_mod)),
  cta_cont_2: a.cta_cont_2 || '',
  cog_2: a.cog_2 || '',
  // ----------------------------------------------
  pbr: a.pbr || '', linea_accion: a.linea_accion || '', um: a.um || '', metas: a.metas || '',
  tipo_beneficiario: a.tipo_beneficiario || '', no_beneficiario: a.no_beneficiario || '',
  fecha_inicio: a.fecha_inicio || '', fecha_final: a.fecha_final || ''
};


    // 2) CONCURRENCIA 1
    const hasC1 = (
        a.oficio_aut_1 || a.fondo_conc_1 || a.cta_cont_1 || a.cog_1 ||
        num(a.imp_conc_1) > 0 || num(a.imp_conc_1_mod) > 0
    );
    let c1_row = null;
    if (hasC1) {
        const c1_amt = moneyOr(a.imp_conc_1_mod, a.imp_conc_1);
        const c1_of = a.oficio_aut_1 || (isABIO(a.fondo_conc_1) ? (a.oficio_aut || '') : '');
        c1_row = {
            id_unico: mkId(),
            id_proyecto,
            fecha_creacion,
            ejercicio: main_row.ejercicio,
            dependencia: main_row.dependencia,
            nombre_obra: main_row.nombre_obra,
            fondo: a.fondo_conc_1 || main_row.fondo,
            oficio_aut: c1_of,
            cta_contable: a.cta_cont_1 || '',
            cog: a.cog_1 || '',
            autorizado: c1_amt,
            autorizado_mod: c1_amt,
            inversion_modificada: c1_amt
        };
    }

    // 3) CONCURRENCIA 2
    const hasC2 = (
        a.oficio_aut_2 || a.fondo_conc_2 || a.cta_cont_2 || a.cog_2 ||
        num(a.imp_conc_2) > 0 || num(a.imp_conc_2_mod) > 0
    );
    let c2_row = null;
    if (hasC2) {
        const c2_amt = moneyOr(a.imp_conc_2_mod, a.imp_conc_2);
        const c2_of = a.oficio_aut_2 || (isABIO(a.fondo_conc_2) ? (a.oficio_aut || '') : '');
        c2_row = {
            id_unico: mkId(),
            id_proyecto,
            fecha_creacion,
            ejercicio: main_row.ejercicio,
            dependencia: main_row.dependencia,
            nombre_obra: main_row.nombre_obra,
            fondo: a.fondo_conc_2 || main_row.fondo,
            oficio_aut: c2_of,
            cta_contable: a.cta_cont_2 || '',
            cog: a.cog_2 || '',
            autorizado: c2_amt,
            autorizado_mod: c2_amt,
            inversion_modificada: c2_amt
        };
    }

    // Persistencia
    base.autorizaciones = base.autorizaciones || [];
    upsert(base.autorizaciones, main_row);
    if (c1_row) upsert(base.autorizaciones, c1_row);
    if (c2_row) upsert(base.autorizaciones, c2_row);

    base.estatus = computeStatus(base);
    await put(base);

    // UI
    $('#dlgAut')?.close();
    await render($('#q')?.value);
    await renderDetails();
    await renderDashboard();
    await renderAutList();
    toast('Autorización guardada');
});

// ========= FUNCIONES DE FICHA AUTORIZACIÓN =========
async function openAutFicha(recId, autId) {
    const rec = await get(recId || selectedId);
    if (!rec) return;
    const aut = (rec.autorizaciones || []).find(a => String(a.id_unico) === String(autId));
    if (!aut) return;

    const fondoClave = aut.fondo || rec.fondo;
    const linked = await collectLinkedMovs(rec.no_expediente, fondoClave);
    const invMod = await computeInvModGlobal(
        rec.no_expediente,
        parseMoney(aut.autorizado_mod || aut.autorizado),
        fondoClave
    );

    const body = $('#autFichaBody');
    if (!body) return;
    body.innerHTML = `
        <div class="kpi" style="margin-bottom:10px">
            <div class="lbl">Fondo • Ejercicio</div><div class="val">${fondoClave || '—'} · ${rec.ejercicio || ''}</div>
        </div>
        <div class="table" style="margin-bottom:10px">
            <table><thead><tr>
                <th>ID Proyecto</th><th>Oficio</th><th>Fondo</th><th>Folio SIFAIS</th><th>Autorizado</th><th>Fecha de autorización</th><th>Inv. Modificada</th>
            </tr></thead><tbody>
            <tr>
                <td>${aut.id_proyecto || rec.no_expediente || '—'}</td>
                <td>${aut.oficio_aut || '—'}</td>
                <td>${fondoClave || '—'}</td>
                <td>${aut.folio_sifais || '—'}</td>
                <td>${fmtMoney(parseMoney(aut.autorizado_mod || aut.autorizado))}</td>
                <td>${aut.fecha_aut || aut.fecha_creacion || '—'}</td>
                <td>${fmtMoney(invMod)}</td>
            </tr>
            </tbody></table>
        </div>
        <div class="detail-card">
            <div class="two-col">
                <div>
                    <div class="h6">Dependencia:</div><div>${rec.dependencia || '—'}</div>
                    <div class="h6">Obra:</div><div>${rec.nombre_obra || '—'}</div>
                    <div class="h6">Oficio:</div><div>${aut.oficio_aut || '—'}</div>
                    <div class="h6">Autorizado:</div><div>${fmtMoney(parseMoney(aut.autorizado_mod || aut.autorizado))}</div>
                    <div class="h6">Fecha de autorización:</div><div>${aut.fecha_aut || aut.fecha_creacion || '—'}</div>
                    <div class="actions" style="margin-top:8px">
                        <button class="small-btn" data-aut-oficio="${aut.id_unico}" data-record="${rec.id}">Oficio</button>
                        <button class="small-btn blue" data-aut-edit="${aut.id_unico}" data-record="${rec.id}">Editar</button>
                    </div>
                </div>
                <div>
                    <div class="h6">No. Expediente:</div><div>${rec.no_expediente || '—'}</div>
                    <div class="h6">Fondo:</div><div>${fondoClave || '—'}</div>
                    <div class="h6">Folio SIFAIS:</div><div>${aut.folio_sifais || '—'}</div>
                    <div class="h6">Inversión Modificada:</div><div>${fmtMoney(invMod)}</div>
                </div>
            </div>
            <div class="two-col" style="margin-top:10px">
                <div><div class="h6">Ampliaciones</div>${linked.amps.length ? `<ul>${linked.amps.map(a => `<li>${a.oficio_ampliacion || a.id_ampliacion || ''} — ${fmtMoney(parseMoney(a.ampliacion_autorizada))}</li>`).join('')}</ul>` : `<div class="muted">—</div>`}</div>
                <div><div class="h6">Cancelaciones</div>${linked.cans.length ? `<ul>${linked.cans.map(a => `<li>${a.oficio_cancelacion || a.id_cancelacion || ''} — ${fmtMoney(parseMoney(a.cancelacion_autorizada))}</li>`).join('')}</ul>` : `<div class="muted">—</div>`}</div>
            </div>
            <div style="margin-top:10px"><div class="h6">Modificaciones</div>${linked.mods.length ? `<ul>${linked.mods.map(a => `<li>${a.oficio_modificacion || a.id_modificacion || ''} — ${fmtMoney(parseMoney(a.modificacion_autorizada))}</li>`).join('')}</ul>` : `<div class="muted">—</div>`}</div>
        </div>`;
    $('#dlgAutFicha')?.showModal();
}

// ========= FUNCIONES DE OFICIO =========
function buildOficioHTML(kind, rec, it) {
    if (kind !== 'aut') {
        const titulo = kind === 'amp' ? 'Oficio de Ampliación' : kind === 'mod' ? 'Oficio de Modificación' : 'Oficio de Cancelación';
        const fecha = (it.fecha_creacion || it.fecha_autorizado || it.fecha_aut || new Date().toISOString().slice(0, 10));
        const montoKey = kind === 'amp' ? 'ampliacion_autorizada' : kind === 'mod' ? 'modificacion_autorizada' : 'cancelacion_autorizada';
        return `
<!doctype html><meta charset="utf-8"><title>${titulo}</title>
<style>
    body{font-family:system-ui;line-height:1.35;padding:24px}
    .box{border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin:10px 0}
    .right{text-align:right}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px 8px;border-bottom:1px solid #e5e7eb}
    .sm{font-size:12px;color:#6b7280}
</style>
<h1>${titulo}</h1>
<div class="box">
    <p><b>Fecha:</b> ${fecha}</p>
    <p><b>No. de oficio:</b> ${it.oficio_ampliacion || it.oficio_modificacion || it.oficio_cancelacion || '—'}</p>
    <p><b>No. de expediente (ID proyecto):</b> ${rec.no_expediente || it.id_proyecto || '—'}</p>
    <p><b>Nombre de la obra:</b> ${rec.nombre_obra || '—'}</p>
    <p><b>Fondo:</b> ${it.fondo || rec.fondo || '—'}</p>
    <p><b>Monto autorizado:</b> ${fmtMoney(parseMoney(it[montoKey]))}</p>
</div>`;
    }

    // Oficio de AUTORIZACIÓN
    const noOficio = it.oficio_aut || '—';
    const idProy = it.id_proyecto || rec.no_expediente || '—';
    const fechaMx = fechaUpperMx(it.fecha_creacion || it.fecha_aut || '');
    const invModN = parseMoney(it.inversion_modificada || it.autorizado_mod || it.autorizado);
    const invMod = fmtMoney(invModN);
    const invLetras = montoALetrasMX(invModN);

    // Base
    const ctaBase = it.cta_contable || '';
    const cogBase = it.cog || '';

    // Concurrencias + oficio por concurrencia
    const concs = [1, 2].map(n => ({
        n,
        fondo: (it[`fondo_conc_${n}`] || '').trim(),
        impBaseN: parseMoney(it[`imp_conc_${n}`]),
        impModN: parseMoney(it[`imp_conc_${n}_mod`]),
        cta: (it[`cta_cont_${n}`] || '').trim(),
        cog: (it[`cog_${n}`] || '').trim(),
        oficio: (it[`oficio_aut_${n}`] || '').trim()
    })).filter(c =>
        c.fondo || c.cta || c.cog || c.oficio || c.impBaseN > 0 || c.impModN > 0
    );

    const totalConcN = concs.reduce((a, c) => a + (c.impModN || c.impBaseN || 0), 0);

    const concTable = concs.length ? `
        <div class="box">
            <div class="sm" style="margin-bottom:6px"><b>Distribución por concurrencias</b></div>
            <table>
                <thead>
                    <tr>
                        <th style="text-align:left">#</th>
                        <th style="text-align:left">Fondo</th>
                        <th class="right">CTA</th>
                        <th class="right">COG</th>
                        <th style="text-align:left">Oficio Aut.</th>
                        <th class="right">Importe base</th>
                        <th class="right">Importe modificado</th>
                    </tr>
                </thead>
                <tbody>
                    ${concs.map(c => `
                        <tr>
                            <td>${c.n}</td>
                            <td>${c.fondo || '—'}</td>
                            <td class="right">${c.cta || '—'}</td>
                            <td class="right">${c.cog || '—'}</td>
                            <td>${c.oficio || '—'}</td>
                            <td class="right">${fmtMoney(c.impBaseN)}</td>
                            <td class="right">${fmtMoney(c.impModN)}</td>
                        </tr>
                    `).join('')}
                    <tr>
                        <td colspan="6" class="right"><b>Total concurrencias</b></td>
                        <td class="right"><b>${fmtMoney(totalConcN)}</b></td>
                    </tr>
                </tbody>
            </table>
        </div>` : '';

    const notaCuadre = concs.length && Math.abs((totalConcN || 0) - (invModN || 0)) > 0.5
        ? `<div class="sm">* Nota: el total por concurrencias (${fmtMoney(totalConcN)}) no coincide con la inversión modificada (${invMod}).</div>`
        : '';

    return `<!doctype html><meta charset="utf-8"><title>Oficio Autorización</title>
<style>
    body{font-family:system-ui;line-height:1.35;padding:24px}
    .box{border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin:10px 0}
    .right{text-align:right}
    .sm{font-size:12px;color:#6b7280}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px 8px;border-bottom:1px solid #e5e7eb}
</style>

<h2>OFICIO DE AUTORIZACIÓN DE AFECTACIÓN PRESUPUESTAL</h2>
<div class="sm">${fechaMx}</div>

<div class="box">
    <table style="width:100%">
        <tr>
            <td><b>No. Oficio:</b> ${noOficio}</td>
            <td class="right"><b>No. Proyecto:</b> ${idProy}</td>
        </tr>
    </table>
</div>

<div class="box">
    <p>Se autoriza la afectación presupuestal por la cantidad de <b>${invMod}</b> (<b>${invLetras}</b>) para el fondo <b>${it.fondo || rec.fondo || '—'}</b>.</p>
    <table>
        <thead><tr><th class="right">Cuenta</th><th>Concepto</th><th class="right">Importe</th></tr></thead>
        <tbody><tr><td class="right">${ctaBase || '—'}</td><td>${cogBase || '—'}</td><td class="right">${invMod}</td></tr></tbody>
    </table>
</div>

${concTable}
${notaCuadre}

<div class="box"><b>Obra:</b> ${rec.nombre_obra || ''}</div>`;
}

// ========= FUNCIONES DE GESTIÓN DE FONDOS =========
function getFondosTechos() {
    return JSON.parse(localStorage.getItem(FONDOS_TECHOS_KEY) || '[]');
}

function upsertFondoTecho(code, techo) {
    const list = getFondosTechos();
    const i = list.findIndex(x => x.code === code);
    const row = { code, techo: Number(techo || 0) };
    if (i >= 0) list[i] = row; else list.push(row);
    localStorage.setItem(FONDOS_TECHOS_KEY, JSON.stringify(list));
}

function getTecho(code) {
    const x = getFondosTechos().find(x => x.code === code);
    return Number(x?.techo || 0);
}

// ========= DELEGACIÓN DE EVENTOS COMPLETA =========
document.addEventListener('click', async (e) => {
    // Botones de acción principales
    const ed = e.target.closest?.('[data-e]');
    const rm = e.target.closest?.('[data-d]');
    const dv = e.target.closest?.('[data-dev]');
    const au = e.target.closest?.('[data-aut]');
    const amp = e.target.closest?.('[data-amp]');
    const mod = e.target.closest?.('[data-mod]');
    const can = e.target.closest?.('[data-can]');

    if (ed) {
        const id = ed.getAttribute('data-e');
        const o = await get(id);
        if (o) fill(o);
        return;
    }

    if (rm) {
        const id = rm.getAttribute('data-d');
        if (confirm('¿Eliminar registro?')) {
            await del(id);
            if (selectedId === id) selectedId = null;
            await render($('#q')?.value);
            hideAllPanels();
            await renderDashboard();
            await renderAutList();
        }
        return;
    }

    if (dv) {
        const id = dv.getAttribute('data-dev');
        const o = await get(id);
        if (!o) return;
        selectedId = id;
        await renderDetails();
        const f = $('#formDev');
        f?.reset();
        $('#formDev [data-f="id_dp"]') && ($('#formDev [data-f="id_dp"]').value = 'DP-' + Math.random().toString(36).slice(2, 8).toUpperCase());
        $('#formDev [data-f="no_expediente"]') && ($('#formDev [data-f="no_expediente"]').value = o.no_expediente || '');
        $('#formDev [data-f="tipo_documento"]') && ($('#formDev [data-f="tipo_documento"]').value = o.tipo_documento || '');
        setupMoneyInForm('#formDev', ['importe']);
        $('#dlgDev')?.showModal();
    }

    // Abrir diálogos Aut/Amp/Mod/Can
    if (au) { await openAutLike(au, 'aut'); return; }
    if (amp) { await openAutLike(amp, 'amp'); return; }
    if (mod) { await openAutLike(mod, 'mod'); return; }
    if (can) { await openAutLike(can, 'can'); return; }

    // Editar/Eliminar individual
    const autEdit = e.target.closest?.('[data-aut-edit]');
    const autDel = e.target.closest?.('[data-aut-del]');
    const ampEdit = e.target.closest?.('[data-amp-edit]');
    const ampDel = e.target.closest?.('[data-amp-del]');
    const modEdit = e.target.closest?.('[data-mod-edit]');
    const modDel = e.target.closest?.('[data-mod-del]');
    const canEdit = e.target.closest?.('[data-can-edit]');
    const canDel = e.target.closest?.('[data-can-del]');
    const devEdit = e.target.closest?.('[data-dev-edit]');
    const devDel = e.target.closest?.('[data-dev-del]');

    // AUTORIZACIÓN: editar
    if (autEdit) {
        const recId = autEdit.getAttribute('data-record');
        const idu = autEdit.getAttribute('data-aut-edit');
        const base = await get(recId || selectedId); if (!base) return;
        const a = (base.autorizaciones || []).find(x => String(x.id_unico) === String(idu)); if (!a) return;
        selectedId = base.id;

        const fondos = JSON.parse(localStorage.getItem(FONDOS_KEY) || '[]');
        fillSelect($('#aut_fondo'), fondos);
        setFormValues('#formAut', a);
        $('#aut_id_unico') && ($('#aut_id_unico').value = a.id_unico);
        $('#aut_id_proy') && ($('#aut_id_proy').value = a.id_proyecto || base.no_expediente || '');
        $('#aut_ejercicio') && ($('#aut_ejercicio').value = base.ejercicio || new Date().getFullYear());
        $('#aut_direccion') && ($('#aut_direccion').value = base.dependencia || '');
        $('#aut_nombre_obra') && ($('#aut_nombre_obra').value = base.nombre_obra || '');
        $('#aut_fondo') && ($('#aut_fondo').value = a.fondo || base.fondo || '');

        setupMoneyInForm('#formAut', [
            'autorizado', 'autorizado_mod', 'inversion_modificada',
            'imp_conc_1', 'imp_conc1_mod', 'imp_conc_2', 'imp_conc2_mod'
        ]);

        showAutConcGroups(a);
        $('#dlgAut')?.showModal();
    }

    // AUTORIZACIÓN: eliminar
    if (autDel) {
        const recId = autDel.getAttribute('data-record');
        const idu = autDel.getAttribute('data-aut-del');
        const base = await get(recId || selectedId); if (!base) return;
        if (!confirm('¿Eliminar autorización?')) return;
        base.autorizaciones = (base.autorizaciones || []).filter(x => String(x.id_unico) !== String(idu));
        base.estatus = computeStatus(base);
        await put(base);
        await renderDetails(); await render($('#q')?.value); await renderDashboard(); await renderAutList();
        toast('Autorización eliminada');
    }

    // AMPLIACIÓN: editar
    if (ampEdit) {
        const recId = ampEdit.getAttribute('data-record');
        const ida = ampEdit.getAttribute('data-amp-edit');
        const base = await get(recId || selectedId); if (!base) return;
        const a = (base.ampliaciones || []).find(x => String(x.id_ampliacion) === String(ida)); if (!a) return;
        selectedId = base.id;

        const fondos = JSON.parse(localStorage.getItem(FONDOS_KEY) || '[]');
        fillSelect($('#amp_fondo'), fondos);
        setFormValues('#formAmp', a);
        $('#amp_id_ampliacion') && ($('#amp_id_ampliacion').value = a.id_ampliacion);
        $('#amp_direccion') && ($('#amp_direccion').value = base.dependencia || '');
        $('#amp_fondo') && ($('#amp_fondo').value = a.fondo || base.fondo || '');
        setupMoneyInForm('#formAmp', ['ampliacion_autorizada', 'ampliacion_concertado_1', 'ampliacion_concertado_2', 'inversion_modificada']);
        $('#dlgAmp')?.showModal();
    }

    // AMPLIACIÓN: eliminar
    if (ampDel) {
        const recId = ampDel.getAttribute('data-record');
        const ida = ampDel.getAttribute('data-amp-del');
        const base = await get(recId || selectedId); if (!base) return;
        if (!confirm('¿Eliminar ampliación?')) return;
        base.ampliaciones = (base.ampliaciones || []).filter(x => String(x.id_ampliacion) !== String(ida));
        base.estatus = computeStatus(base);
        await put(base);
        await renderDetails(); await render($('#q')?.value); await renderDashboard(); await renderAutList();
        toast('Ampliación eliminada');
    }

    // MODIFICACIÓN: editar
    if (modEdit) {
        const recId = modEdit.getAttribute('data-record');
        const idm = modEdit.getAttribute('data-mod-edit');
        const base = await get(recId || selectedId); if (!base) return;
        const a = (base.modificaciones || []).find(x => String(x.id_modificacion) === String(idm)); if (!a) return;
        selectedId = base.id;

        const fondos = JSON.parse(localStorage.getItem(FONDOS_KEY) || '[]');
        fillSelect($('#mod_fondo'), fondos);
        setFormValues('#formMod', a);
        $('#mod_id_modificacion') && ($('#mod_id_modificacion').value = a.id_modificacion);
        $('#mod_direccion') && ($('#mod_direccion').value = base.dependencia || '');
        $('#mod_fondo') && ($('#mod_fondo').value = a.fondo || base.fondo || '');
        setupMoneyInForm('#formMod', ['modificacion_autorizada', 'modificacion_concertado_1', 'modificacion_concertado_2', 'inversion_modificada']);
        $('#dlgMod')?.showModal();
    }

    // MODIFICACIÓN: eliminar
    if (modDel) {
        const recId = modDel.getAttribute('data-record');
        const idm = modDel.getAttribute('data-mod-del');
        const base = await get(recId || selectedId); if (!base) return;
        if (!confirm('¿Eliminar modificación?')) return;
        base.modificaciones = (base.modificaciones || []).filter(x => String(x.id_modificacion) !== String(idm));
        base.estatus = computeStatus(base);
        await put(base);
        await renderDetails(); await render($('#q')?.value); await renderDashboard(); await renderAutList();
        toast('Modificación eliminada');
    }

    // CANCELACIÓN: editar
    if (canEdit) {
        const recId = canEdit.getAttribute('data-record');
        const idc = canEdit.getAttribute('data-can-edit');
        const base = await get(recId || selectedId); if (!base) return;
        const a = (base.cancelaciones || []).find(x => String(x.id_cancelacion) === String(idc)); if (!a) return;
        selectedId = base.id;

        const fondos = JSON.parse(localStorage.getItem(FONDOS_KEY) || '[]');
        fillSelect($('#can_fondo'), fondos);
        setFormValues('#formCan', a);
        $('#can_id_cancelacion') && ($('#can_id_cancelacion').value = a.id_cancelacion);
        $('#can_direccion') && ($('#can_direccion').value = base.dependencia || '');
        $('#can_fondo') && ($('#can_fondo').value = a.fondo || base.fondo || '');
        setupMoneyInForm('#formCan', ['cancelacion_autorizada', 'cancelacion_concertado_1', 'cancelacion_concertado_2']);
        $('#dlgCan')?.showModal();
    }

    // CANCELACIÓN: eliminar
    if (canDel) {
        const recId = canDel.getAttribute('data-record');
        const idc = canDel.getAttribute('data-can-del');
        const base = await get(recId || selectedId); if (!base) return;
        if (!confirm('¿Eliminar cancelación?')) return;
        base.cancelaciones = (base.cancelaciones || []).filter(x => String(x.id_cancelacion) !== String(idc));
        base.estatus = computeStatus(base);
        await put(base);
        await renderDetails(); await render($('#q')?.value); await renderDashboard(); await renderAutList();
        toast('Cancelación eliminada');
    }

    // DEVOLUCIÓN: editar
    if (devEdit) {
        const recId = devEdit.getAttribute('data-record');
        const idd = devEdit.getAttribute('data-dev-edit');
        const base = await get(recId || selectedId); if (!base) return;
        const d = (base.devoluciones || []).find(x => String(x.id_dp) === String(idd)); if (!d) return;
        selectedId = base.id;

        setFormValues('#formDev', d);
        setupMoneyInForm('#formDev', ['importe']);
        $('#dlgDev')?.showModal();
    }

    // DEVOLUCIÓN: eliminar
    if (devDel) {
        const recId = devDel.getAttribute('data-record');
        const idd = devDel.getAttribute('data-dev-del');
        const base = await get(recId || selectedId); if (!base) return;
        if (!confirm('¿Eliminar devolución?')) return;
        base.devoluciones = (base.devoluciones || []).filter(x => String(x.id_dp) !== String(idd));
        base.estatus = computeStatus(base);
        await put(base);
        await renderDetails(); await render($('#q')?.value); await renderDashboard();
        toast('Devolución eliminada');
    }

    // FICHA y OFICIO desde vista Autorizaciones
    const fichaBtn = e.target.closest?.('[data-aut-ficha]');
    const oficioBtn = e.target.closest?.('[data-aut-oficio]');

    if (fichaBtn) {
        const recId = fichaBtn.getAttribute('data-record') || selectedId;
        const autId = fichaBtn.getAttribute('data-aut-ficha');
        await openAutFicha(recId, autId);
        return;
    }

    if (oficioBtn) {
        const recId = oficioBtn.getAttribute('data-record') || selectedId;
        const autId = oficioBtn.getAttribute('data-aut-oficio');
        // Aquí puedes implementar la función para generar el oficio PDF
        toast('Generando oficio...');
        return;
    }
});

// ========= INICIALIZACIÓN ADICIONAL =========
function setupCancelacionMoneyInputs() {
    try {
        setupMoneyInForm('#formCan', [
            'cancelacion_autorizada',
            'cancelacion_concertado_1',
            'cancelacion_concertado_2'
        ]);
    } catch { }
}

// Guardar techo por fondo
document.addEventListener('blur', (e) => {
    const inp = e.target.closest?.('[data-techo-input]');
    if (!inp) return;
    const tr = inp.closest('tr[data-fondo]');
    const code = tr?.getAttribute('data-fondo');
    const val = parseMoney(inp.value);
    upsertFondoTecho(code, val);
    inp.value = fmt2(val);
}, true);

// Buscador lista principal
$('#q')?.addEventListener('input', () => {
    clearTimeout($('#q')._t);
    $('#q')._t = setTimeout(() => render($('#q').value), 180);
});

// Botones adicionales
$('#addConc')?.addEventListener('click', () => addConc());
$('#btnAddDep')?.addEventListener('click', addDepToCatalog);
$('#btnAddFondo')?.addEventListener('click', addFondoToCatalog);
$('#save')?.addEventListener('click', saveMainRecord);
$('#btnew')?.addEventListener('click', newMainRecord);
$('#clear')?.addEventListener('click', () => {
    document.getElementById('f')?.reset();
    parseNoExpToControls('');
    const wrap = $('#concWrap');
    if (wrap) wrap.innerHTML = '';
    recalc();
});

// Funciones de directorio
function addDepToCatalog() {
    const name = prompt('Nueva dependencia:')?.trim();
    if (!name) return;
    const dir = JSON.parse(localStorage.getItem(DIR_KEY) || '[]');
    if (!dir.some(x => x.dep === name)) {
        dir.push({ dep: name, director: '', cargo: '' });
        localStorage.setItem(DIR_KEY, JSON.stringify(dir));
        updateDependencyOptions();
        $('#dependencia')?.value && ($('#dependencia').value = name);
        renderDirectorioView();
        toast('Dependencia agregada al Directorio');
    } else {
        updateDependencyOptions();
        $('#dependencia')?.value && ($('#dependencia').value = name);
        toast('La dependencia ya existe en el Directorio');
    }
}

function addFondoToCatalog() {
    const list = JSON.parse(localStorage.getItem(FONDOS_KEY) || '[]');
    const meta = JSON.parse(localStorage.getItem(FONDOS_META_KEY) || '[]');
    const val = prompt('Nuevo fondo (código):')?.trim();
    if (!val) return;
    if (!list.includes(val)) list.push(val);
    if (!meta.some(m => m.code === val)) meta.push({ code: val, full_name: val });
    localStorage.setItem(FONDOS_KEY, JSON.stringify(list));
    localStorage.setItem(FONDOS_META_KEY, JSON.stringify(meta));
    fillSelect($('#fondo'), list);
    fillSelect($('#autListFondo'), ['(Todos)', ...list]);
    if ($('#fondo')) $('#fondo').value = val;
    toast('Fondo agregado');
}

// Exportar funciones globalmente
window.openAutLike = openAutLike;
window.renderDirectorioView = renderDirectorioView;
window.renderAutList = renderAutList;
window.openAutFicha = openAutFicha;


</script>
</body>
</html>

